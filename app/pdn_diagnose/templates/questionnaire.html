<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8"/>
    <title>PDN Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&family=Varela+Round&display=swap"
          rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <!-- Include audio handler script -->
    <script src="/static/js/audio-handler.js"></script>
    <style>
      body { background: radial-gradient(ellipse at center, #e0e7ff 0%, #c7d2fe 50%, #a5b4fc 100%); font-family: 'Rubik', sans-serif; min-height: 100vh; }
      .glass-effect { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 1.5rem; box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
      @keyframes fadeInUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
      .fade-in { animation: fadeInUp 0.4s cubic-bezier(0.4,0,0.2,1) both; }
      .modal-backdrop {
        position: fixed; inset: 0; background: rgba(55, 48, 163, 0.3); display: none;
        align-items: center; justify-content: center; z-index: 50;
        animation: modalBackdropIn .4s both;
      }
      @keyframes modalBackdropIn { from { opacity: 0; } to { opacity: 1; } }
      .modal-animate {
        animation: modalScaleIn .45s cubic-bezier(0.4,0,0.2,1) both;
      }
      @keyframes modalScaleIn { from { opacity: 0; transform: scale(0.88) translateY(32px);} to { opacity: 1; transform: scale(1) translateY(0);} }
      .glow {
        box-shadow: 0 0 30px 0 #a5b4fc88, 0 2px 32px 0 #818cf880;
      }
      .modal-icon {
        font-size: 2.5rem;
        color: #7c3aed;
        filter: drop-shadow(0 2px 4px #818cf880);
        margin-bottom: 12px;
        animation: iconPop .6s cubic-bezier(0.68,-0.55,0.27,1.55);
      }
      @keyframes iconPop { 0% { transform: scale(0); } 70% { transform: scale(1.22); } 100% { transform: scale(1); } }
      .modal-close-btn {
        transition: background .22s, transform .15s;
      }
      .modal-close-btn:hover {
        background: linear-gradient(to left, #7c3aed 80%, #6366f1 100%);
        transform: scale(1.05) translateY(-2px);
        box-shadow: 0 2px 8px #a5b4fc44;
      }
      @media (max-width: 600px) {
        .glass-effect, .modal-card { padding: 1.2rem !important; }
      }
      /* Voice record UI */
      #voiceRecordArea .recording {
        color: #7c3aed;
        font-weight: bold;
        animation: pulse 1.1s infinite alternate;
      }
      @keyframes pulse { from { opacity: 1;} to { opacity: 0.5;} }
      .audio-bar {
        width: 8px; height: 22px; background: #7c3aed; margin: 0 2px; border-radius: 5px; display: inline-block; vertical-align: bottom;
        animation: bounce 1s infinite alternate;
      }
      .audio-bar:nth-child(2) { animation-delay: .15s; }
      .audio-bar:nth-child(3) { animation-delay: .3s; }
      .audio-bar:nth-child(4) { animation-delay: .45s; }
      .audio-bar:nth-child(5) { animation-delay: .6s; }
      @keyframes bounce {
        from { height: 8px; background: #c4b5fd; }
        to   { height: 22px; background: #7c3aed; }
      }
      .ranking-number.selected {
        color: #7c3aed; /* Tailwind's purple-600 */
        font-weight: bold;
      }
      .ranking-number {
        color: #7c3aed;   /* Tailwind's purple-600 */
        font-weight: bold;
      }

      /* Voice recording validation styles */
      .text-orange-600 {
        color: #ea580c;
      }
      .text-green-600 {
        color: #16a34a;
      }
      .text-red-600 {
        color: #dc2626;
      }
      .opacity-50 {
        opacity: 0.5;
      }
      .cursor-not-allowed {
        cursor: not-allowed;
      }
      .recording-validation {
        transition: all 0.3s ease;
      }
      .recording-validation.valid {
        border-color: #16a34a;
        box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
      }
      .recording-validation.invalid {
        border-color: #dc2626;
        box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
      }
      .recording-validation.recording {
        border-color: #ea580c;
        box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.1);
      }


    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

<!-- Modal for stage instructions -->
<div id="instructionModal" class="fixed inset-0 backdrop-blur-sm hidden items-center justify-center z-50"
     style="background: radial-gradient(ellipse at center, #e0e7ff 0%, #c7d2fe 50%, #a5b4fc 100%);"
>
    <div class="relative bg-gradient-to-r from-purple-100 to-indigo-100 rounded-2xl p-8 max-w-md w-full glass-effect glow animate-fade-in-up shadow-2xl text-center">

        <!-- Animated bulb icon -->
        <div class="text-4xl mb-4 animate-bounce">💡</div>
        <!-- Title (if used) -->
        <h3 id="modalTitle" class="text-lg font-extrabold mb-2" style="font-family:'Varela Round',cursive"></h3>
        <!-- Instruction text -->
        <p id="modalText" class="text-lg text-right text-gray-800 whitespace-pre-line mb-6 leading-relaxed"></p>
        <!-- Action button -->
        <button id="modalClose"
                class="mx-auto block py-3 px-8 text-lg bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg font-semibold shadow-lg hover:shadow-2xl focus:outline-none focus:ring-4 focus:ring-purple-400/30 transform transition duration-300 hover:scale-105 animate-pulse">
            יופי, אפשר להתקדם!
        </button>
    </div>
</div>

<style>
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(24px);}
    to { opacity: 1; transform: translateY(0);}
  }
  .animate-fade-in-up {
    animation: fadeInUp 0.5s cubic-bezier(0.4,0,0.2,1) both;
  }
  @keyframes bounce {
    0%, 100% { transform: translateY(0);}
    50% { transform: translateY(-10px);}
  }
  .animate-bounce {
    animation: bounce 1.2s infinite;
  }
  @keyframes pulse {
    0% { transform: scale(1);}
    50% { transform: scale(1.05);}
    100% { transform: scale(1);}
  }
  .animate-pulse {
    animation: pulse 2s infinite;
  }


</style>


<main id="chatArea" class="glass-effect p-8 rounded-2xl shadow-2xl w-full max-w-2xl border border-white/20 space-y-6">
    <!-- Hidden fields for user data -->
    <input type="hidden" id="userName" value="{{ user_name or '' }}">
    <input type="hidden" id="userId" value="{{ user_id or '' }}">
    <h1 class="text-4xl font-bold text-center text-gray-800 bg-gradient-to-r from-purple-600 to-indigo-600 bg-clip-text text-transparent">
        {% if user_name %}ברוך הבא, {{ user_name }}{% else %}אבחון קוד המקור{% endif %}
    </h1>
    <div id="messages" class="space-y-4 fade-in">

        <!-- Voice Recording Section -->
        <div id="voiceRecordArea"
             class="p-6 rounded-xl border border-indigo-100 bg-gradient-to-r from-purple-100 to-indigo-100 text-gray-800 shadow-sm fade-in text-right recording-validation"
             dir="rtl">
            <p class="text-lg mb-4">שלום וברוך הבא,</p>
            <p class="text-lg mb-4">בוא נגלה יחד את קוד המקור הייחודי שלך, המצפן הפנימי שלך לצמיחה והתפתחות.</p>
            <p class="text-lg mb-4">ענה על שתי שאלות הבאות לזיהוי קוד המקור שלך:</p>
            <div class="bg-white p-4 rounded border-r-4 border-blue-400">
                <span>1.</span> ספר לי על חוויה חיובית או מרגשת שחווית בשנה האחרונה. משהו שנגע בך או שימח אותך במיוחד.
            </div>
            </br>
            <div>
                <button id="startRecordBtn"
                        class="text-lg py-3 px-7 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl shadow-lg font-semibold">
                    התחל להקליט
                </button>
                <button id="stopRecordBtn"
                        class="hidden text-lg py-3 px-7 bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-xl shadow-lg font-semibold ml-2">
                    סיים הקלטה
                </button>
            </div>
            <div id="recordStatus" class="text-lg text-purple-700"></div>
            <div id="visualizer" class="flex justify-center items-end space-x-1 mb-1"
                 style="height:24px;direction:ltr"></div>
            <audio id="audioPlayback" controls class="hidden mx-auto" style="max-width:260px"></audio>
            <!-- Audio upload status -->
            <div id="uploadStatus" class="text-center mt-4 hidden">
                <div class="text-green-600 font-semibold">הקלטה נשמרה בהצלחה!</div>
            </div>
        </div>
    </div>

    <!-- Second Voice Record Area -->
    <div id="voiceRecordArea2"
         class="p-6 rounded-xl border border-indigo-100 bg-gradient-to-r from-purple-100 to-indigo-100 text-gray-800 shadow-sm fade-in text-right hidden recording-validation"
         dir="rtl">
        <p class="text-lg mb-4">תודה על התשובה הראשונה!</p>
        <p class="text-lg mb-4">עכשיו בוא נעמיק קצת יותר. אנא ענה על השאלה הבאה:</p>
        <div class="bg-white p-4 rounded border-r-4 border-blue-400">
            <span>2.</span> ספר לי על אתגר משמעותי שהתמודדת איתו לאחרונה – משהו שהיה לך לא פשוט, ואיך הצלחת לעבור
            אותו.
        </div>
        </br>
        <div>
            <button id="startRecordBtn2"
                    class="text-lg py-3 px-7 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl shadow-lg font-semibold">
                התחל להקליט
            </button>
            <button id="stopRecordBtn2"
                    class="hidden text-lg py-3 px-7 bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-xl shadow-lg font-semibold ml-2">
                סיים הקלטה
            </button>
        </div>
        <div id="recordStatus2" class="text-lg text-purple-700"></div>
        <div id="visualizer2" class="flex justify-center items-end space-x-1 mb-1"
             style="height:24px;direction:ltr"></div>
        <audio id="audioPlayback2" controls class="hidden mx-auto" style="max-width:260px"></audio>
        <!-- Audio upload status -->
        <div id="uploadStatus2" class="text-center mt-4 hidden">
            <div class="text-green-600 font-semibold">הקלטה נשמרה בהצלחה!</div>
        </div>
    </div>
    <div id="questionArea" class="hidden space-y-6">
        <h2 id="questionText"
            class="text-lg font-semibold text-gray-700 mb-4 bg-gradient-to-r from-purple-600 to-indigo-600 bg-clip-text text-transparent"></h2>
        <div id="options" class="space-y-3"></div>
    </div>

    <!-- Footer Link -->
    <div class="text-center pt-4 space-y-4">
        <button id="backButton" onclick="goBack()"
                class="text-sm w-1/2 py-2 px-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-medium rounded-xl hover:from-purple-700 hover:to-indigo-700 focus:outline-none focus:ring-4 focus:ring-purple-500/50 transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98] shadow-lg hidden">
            חזור לשאלה הקודמת
        </button>
        <!-- Footer Link -->
        <div class="text-center pt-4">
            <p class="text-sm sm:text-base font-medium bg-gradient-to-r from-purple-600 via-pink-500 to-indigo-500 bg-clip-text text-transparent animate-pulse">
                ✨ <a href="https://www.pdn.co.il" target="_blank" class="hover:underline">Personal Development
                Navigator</a>
                ✨
            </p>
            <div class="border-t border-gray-200 pt-6">
                <p class="text-xs text-gray-500">
                    © 2024 PDN Center כל הזכויות שמורות
                </p>
                <p class="text-xs text-gray-400 mt-2">
                    מערכת ניהול נתוני אבחון פדן - גרסה 1.0
                </p>
            </div>
        </div>
    </div>

</main>

<script>
let currentQuestion = 1;
let currentStage = '';
let nextData = null;
let questionHistory = []; // Array to store question history
let currentUsername = '{{ email }}' || 'anonymous'; // Get username from template

// Modal logic
const modal = document.getElementById('instructionModal');
const modalTitle = document.getElementById('modalTitle');
const modalText = document.getElementById('modalText');
document.getElementById('modalClose').onclick = () => {
    modal.style.display = 'none';
    document.body.style.overflow = "";
    if (nextData) { actuallyRenderQuestion(nextData); nextData = null; }
};

// Voice record logic
let mediaRecorder;
let audioChunks = [];
let recordTimer = null;
let recordElapsed = 0;
let recordingValid = false; // Track if recording meets duration requirements

const startBtn = document.getElementById('startRecordBtn');
const stopBtn = document.getElementById('stopRecordBtn');
const recordStatus = document.getElementById('recordStatus');
const audioPlayback = document.getElementById('audioPlayback');
const visualizer = document.getElementById('visualizer');
const uploadStatus = document.getElementById('uploadStatus');

startBtn.onclick = async function() {
    audioChunks = [];
    recordingValid = false;
    recordStatus.innerHTML = '<span class="recording">מקליט... (00:00 / 01:00-01:30)</span>';
    startBtn.classList.add('hidden');
    stopBtn.classList.remove('hidden');
    stopBtn.innerText = 'סיים הקלטה';
    stopBtn.disabled = true;
    stopBtn.classList.add('opacity-50', 'cursor-not-allowed');
    audioPlayback.classList.add('hidden');
    visualizer.innerHTML = '';
    
    // Add visual feedback for recording state
    const voiceArea = document.getElementById('voiceRecordArea');
    voiceArea.classList.remove('valid', 'invalid');
    voiceArea.classList.add('recording');
    
    // Add fake bars for animation
    for(let i=0;i<5;i++){
        const bar = document.createElement('div');
        bar.className = 'audio-bar';
        visualizer.appendChild(bar);
    }
    recordElapsed = 0;
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = async e => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            audioPlayback.src = URL.createObjectURL(audioBlob);
            audioPlayback.classList.remove('hidden');
            visualizer.innerHTML = '';
            
            // Check if recording duration is valid
            if (recordElapsed >= 60 && recordElapsed <= 90) {
                recordingValid = true;
                recordStatus.innerHTML = '<span class="text-green-600 font-bold">✓ הקלטה תקינה (' + formatTime(recordElapsed) + ')</span>';
                stopBtn.innerText = 'המשך לשאלה הבאה';
                stopBtn.disabled = false;
                stopBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                
                // Add visual feedback for valid state
                const voiceArea = document.getElementById('voiceRecordArea');
                voiceArea.classList.remove('recording', 'invalid');
                voiceArea.classList.add('valid');
                
                // Upload audio to backend
                try {
                    const result = await saveUserAudio(currentUsername, audioBlob, 'question1');
                    uploadStatus.classList.remove('hidden');
                    uploadStatus.innerHTML = '<div class="text-green-600 font-semibold">הקלטה נשמרה בהצלחה!</div>';
                    console.log('Audio uploaded successfully:', result);
                } catch (error) {
                    console.error('Failed to upload audio:', error);
                    uploadStatus.classList.remove('hidden');
                    uploadStatus.innerHTML = '<div class="text-red-600 font-semibold">שגיאה בשמירת ההקלטה</div>';
                }
            } else {
                recordingValid = false;
                if (recordElapsed < 60) {
                    recordStatus.innerHTML = '<span class="text-red-600 font-bold">✗ הקלטה קצרה מדי (' + formatTime(recordElapsed) + '). נדרש לפחות דקה אחת.</span>';
                } else {
                    recordStatus.innerHTML = '<span class="text-red-600 font-bold">✗ הקלטה ארוכה מדי (' + formatTime(recordElapsed) + '). נדרש לכל היותר דקה וחצי.</span>';
                }
                stopBtn.innerText = 'נסה שוב';
                stopBtn.disabled = false;
                stopBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                uploadStatus.classList.add('hidden');
                
                // Add visual feedback for invalid state
                const voiceArea = document.getElementById('voiceRecordArea');
                voiceArea.classList.remove('recording', 'valid');
                voiceArea.classList.add('invalid');
            }
        };
        mediaRecorder.start();
        // Timer for duration
        recordTimer = setInterval(() => {
            recordElapsed++;
            let sec = recordElapsed % 60, min = Math.floor(recordElapsed / 60);
            let statusText = `מקליט... (${("0"+min).slice(-2)}:${("0"+sec).slice(-2)} / 01:00-01:30)`;
            
            // Change color based on duration
            if (recordElapsed >= 60 && recordElapsed <= 90) {
                statusText = `<span class="text-green-600">${statusText} ✓</span>`;
                stopBtn.disabled = false;
                stopBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else if (recordElapsed > 90) {
                statusText = `<span class="text-red-600">${statusText} ✗</span>`;
                stopBtn.disabled = false;
                stopBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                statusText = `<span class="text-orange-600">${statusText}</span>`;
                stopBtn.disabled = true;
                stopBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
            
            recordStatus.innerHTML = statusText;
            
            // Auto-stop at 2 minutes to prevent excessive recording
            if(recordElapsed >= 120) {
                finishRecording();
            }
        }, 1000);
    } catch (err) {
        recordStatus.innerHTML = '<span class="text-red-600 font-semibold">שגיאה בגישה למיקרופון</span>';
        stopBtn.classList.add('hidden');
        startBtn.classList.remove('hidden');
        visualizer.innerHTML = '';
    }
};

function formatTime(seconds) {
    const min = Math.floor(seconds / 60);
    const sec = seconds % 60;
    return `${("0"+min).slice(-2)}:${("0"+sec).slice(-2)}`;
}

function finishRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        clearInterval(recordTimer);
    }
}

stopBtn.onclick = function() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        finishRecording();
    } else if (recordingValid) {
        document.getElementById('voiceRecordArea').classList.add('hidden');
        document.getElementById('voiceRecordArea2').classList.remove('hidden');
        // Reset the second voice UI
        resetVoiceUI2();
    } else {
        // Reset for retry
        resetVoiceUI();
    }
};

function resetVoiceUI() {
    startBtn.classList.remove('hidden');
    stopBtn.classList.add('hidden');
    stopBtn.innerText = 'סיים הקלטה';
    stopBtn.disabled = false;
    stopBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    recordStatus.innerHTML = '';
    audioPlayback.classList.add('hidden');
    audioPlayback.src = '';
    visualizer.innerHTML = '';
    uploadStatus.classList.add('hidden');
    recordingValid = false;
    
    // Clear visual feedback
    const voiceArea = document.getElementById('voiceRecordArea');
    voiceArea.classList.remove('recording', 'valid', 'invalid');
    
    if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
    if (recordTimer) clearInterval(recordTimer);
}

// Second Voice Record Area Logic
let mediaRecorder2;
let audioChunks2 = [];
let recordTimer2 = null;
let recordElapsed2 = 0;
let recordingValid2 = false; // Track if recording meets duration requirements

const startBtn2 = document.getElementById('startRecordBtn2');
const stopBtn2 = document.getElementById('stopRecordBtn2');
const recordStatus2 = document.getElementById('recordStatus2');
const audioPlayback2 = document.getElementById('audioPlayback2');
const visualizer2 = document.getElementById('visualizer2');
const uploadStatus2 = document.getElementById('uploadStatus2');

startBtn2.onclick = async function() {
    audioChunks2 = [];
    recordingValid2 = false;
    recordStatus2.innerHTML = '<span class="recording">מקליט... (00:00 / 01:00-01:30)</span>';
    startBtn2.classList.add('hidden');
    stopBtn2.classList.remove('hidden');
    stopBtn2.innerText = 'סיים הקלטה';
    stopBtn2.disabled = true;
    stopBtn2.classList.add('opacity-50', 'cursor-not-allowed');
    audioPlayback2.classList.add('hidden');
    visualizer2.innerHTML = '';
    
    // Add visual feedback for recording state
    const voiceArea2 = document.getElementById('voiceRecordArea2');
    voiceArea2.classList.remove('valid', 'invalid');
    voiceArea2.classList.add('recording');
    
    // Add fake bars for animation
    for(let i=0;i<5;i++){
        const bar = document.createElement('div');
        bar.className = 'audio-bar';
        visualizer2.appendChild(bar);
    }
    recordElapsed2 = 0;
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder2 = new MediaRecorder(stream);
        mediaRecorder2.ondataavailable = e => audioChunks2.push(e.data);
        mediaRecorder2.onstop = async e => {
            const audioBlob = new Blob(audioChunks2, { type: 'audio/webm' });
            audioPlayback2.src = URL.createObjectURL(audioBlob);
            audioPlayback2.classList.remove('hidden');
            visualizer2.innerHTML = '';
            
            // Check if recording duration is valid
            if (recordElapsed2 >= 60 && recordElapsed2 <= 90) {
                recordingValid2 = true;
                recordStatus2.innerHTML = '<span class="text-green-600 font-bold">✓ הקלטה תקינה (' + formatTime(recordElapsed2) + ')</span>';
                stopBtn2.innerText = 'המשך לאיבחון';
                stopBtn2.disabled = false;
                stopBtn2.classList.remove('opacity-50', 'cursor-not-allowed');
                
                // Add visual feedback for valid state
                const voiceArea2 = document.getElementById('voiceRecordArea2');
                voiceArea2.classList.remove('recording', 'invalid');
                voiceArea2.classList.add('valid');
                
                // Upload audio to backend with different filename
                try {
                    const result = await saveUserAudio(currentUsername, audioBlob, 'question2');
                    uploadStatus2.classList.remove('hidden');
                    uploadStatus2.innerHTML = '<div class="text-green-600 font-semibold">הקלטה נשמרה בהצלחה!</div>';
                    console.log('Second audio uploaded successfully:', result);
                } catch (error) {
                    console.error('Failed to upload second audio:', error);
                    uploadStatus2.classList.remove('hidden');
                    uploadStatus2.innerHTML = '<div class="text-red-600 font-semibold">שגיאה בשמירת ההקלטה</div>';
                }
            } else {
                recordingValid2 = false;
                if (recordElapsed2 < 60) {
                    recordStatus2.innerHTML = '<span class="text-red-600 font-bold">✗ הקלטה קצרה מדי (' + formatTime(recordElapsed2) + '). נדרש לפחות דקה אחת.</span>';
                } else {
                    recordStatus2.innerHTML = '<span class="text-red-600 font-bold">✗ הקלטה ארוכה מדי (' + formatTime(recordElapsed2) + '). נדרש לכל היותר דקה וחצי.</span>';
                }
                stopBtn2.innerText = 'נסה שוב';
                stopBtn2.disabled = false;
                stopBtn2.classList.remove('opacity-50', 'cursor-not-allowed');
                uploadStatus2.classList.add('hidden');
                
                // Add visual feedback for invalid state
                const voiceArea2 = document.getElementById('voiceRecordArea2');
                voiceArea2.classList.remove('recording', 'valid');
                voiceArea2.classList.add('invalid');
            }
        };
        mediaRecorder2.start();
        // Timer for duration
        recordTimer2 = setInterval(() => {
            recordElapsed2++;
            let sec = recordElapsed2 % 60, min = Math.floor(recordElapsed2 / 60);
            let statusText = `מקליט... (${("0"+min).slice(-2)}:${("0"+sec).slice(-2)} / 01:00-01:30)`;
            
            // Change color based on duration
            if (recordElapsed2 >= 60 && recordElapsed2 <= 90) {
                statusText = `<span class="text-green-600">${statusText} ✓</span>`;
                stopBtn2.disabled = false;
                stopBtn2.classList.remove('opacity-50', 'cursor-not-allowed');
            } else if (recordElapsed2 > 90) {
                statusText = `<span class="text-red-600">${statusText} ✗</span>`;
                stopBtn2.disabled = false;
                stopBtn2.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                statusText = `<span class="text-orange-600">${statusText}</span>`;
                stopBtn2.disabled = true;
                stopBtn2.classList.add('opacity-50', 'cursor-not-allowed');
            }
            
            recordStatus2.innerHTML = statusText;
            
            // Auto-stop at 2 minutes to prevent excessive recording
            if(recordElapsed2 >= 120) {
                finishRecording2();
            }
        }, 1000);
    } catch (err) {
        recordStatus2.innerHTML = '<span class="text-red-600 font-semibold">שגיאה בגישה למיקרופון</span>';
        stopBtn2.classList.add('hidden');
        startBtn2.classList.remove('hidden');
        visualizer2.innerHTML = '';
    }
};

function finishRecording2() {
    if (mediaRecorder2 && mediaRecorder2.state === 'recording') {
        mediaRecorder2.stop();
        clearInterval(recordTimer2);
    }
}

stopBtn2.onclick = function() {
    if (mediaRecorder2 && mediaRecorder2.state === 'recording') {
        finishRecording2();
    } else if (recordingValid2) {
        document.getElementById('voiceRecordArea2').classList.add('hidden');
        document.getElementById('questionArea').classList.remove('hidden');
        loadQuestion(currentQuestion);
    } else {
        // Reset for retry
        resetVoiceUI2();
    }
};

function resetVoiceUI2() {
    startBtn2.classList.remove('hidden');
    stopBtn2.classList.add('hidden');
    stopBtn2.innerText = 'סיים הקלטה';
    stopBtn2.disabled = false;
    stopBtn2.classList.remove('opacity-50', 'cursor-not-allowed');
    recordStatus2.innerHTML = '';
    audioPlayback2.classList.add('hidden');
    audioPlayback2.src = '';
    visualizer2.innerHTML = '';
    uploadStatus2.classList.add('hidden');
    recordingValid2 = false;
    
    // Clear visual feedback
    const voiceArea2 = document.getElementById('voiceRecordArea2');
    voiceArea2.classList.remove('recording', 'valid', 'invalid');
    
    if (mediaRecorder2 && mediaRecorder2.state === 'recording') mediaRecorder2.stop();
    if (recordTimer2) clearInterval(recordTimer2);
}

// Question/Modal logic
async function loadQuestion(questionNumber) {
    const response = await fetch(`/pdn-diagnose/questionnaire/${questionNumber}`);
    const data = await response.json();
    if (data.message === "No more questions.") return completeQuestionnaire();
    if (data.stage !== currentStage) {
        currentStage = data.stage;
        if (data.instructions) {
          //<div id="voiceRecordArea" class="p-6 rounded-xl border border-indigo-100 bg-gradient-to-r from-purple-100 to-indigo-100 text-gray-800 shadow-sm fade-in text-right" dir="rtl">

            //modalTitle.innerHTML = "<div class=' p-6 text-lg font-bold text-gray-700 ' >הסבר:</div>";
            modalText.innerText = data.instructions;
            modal.style.display = 'flex';
            document.body.style.overflow = "hidden";
            setTimeout(() => {
                modal.classList.remove('modal-animate');
                void modal.offsetWidth; // Force reflow
                modal.classList.add('modal-animate');
            }, 10);
            nextData = data;
            return;
        }
    }
    actuallyRenderQuestion(data);
}

function actuallyRenderQuestion(data) {
    document.getElementById('questionText').innerText = data.question;
    const optionsDiv = document.getElementById('options');
    optionsDiv.innerHTML = '';
    
    // Show/hide back button based on question history
    const backButton = document.getElementById('backButton');
    backButton.classList.toggle('hidden', questionHistory.length === 0);

    if (['PartC','PartD'].includes(data.stage)) {
        renderScaleQuestion(data, data.question_number);
        return;
    }
    if (data.type === 'ranking') {
        renderRankingQuestion(data, data.question_number);
        return;
    }
    
    // Create an array of buttons first
    const buttons = data.options.map(opt => {
        const btn = document.createElement('button');
        btn.innerText = opt.text;
        btn.className = 'text-lg fade-in w-full py-4 px-6 bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-medium rounded-xl hover:from-purple-700 hover:to-indigo-700 focus:outline-none focus:ring-4 focus:ring-purple-500/50 transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98] shadow-lg';
        btn.onclick = () => submitAnswer(data.question_number, opt.code, opt.text);
        return btn;
    });
    
    // Randomize the order of buttons
    buttons.sort(() => Math.random() - 0.5);
    
    // Append the randomized buttons to the options div
    buttons.forEach(btn => optionsDiv.appendChild(btn));
}

function renderScaleQuestion(data, questionNumber) {
      const container = document.createElement('div');
      container.className = 'space-y-4';

      const labelsRow = document.createElement('div');
      labelsRow.className = 'flex justify-between items-center';

      const leftLabel = document.createElement('span');
      leftLabel.textContent = data.options[0].text;
      const rightLabel = document.createElement('span');
      rightLabel.textContent = data.options[1].text;

      labelsRow.append(leftLabel, rightLabel);
      container.append(labelsRow);

      const [lText, rText] = data.options.map(o => o.text);
      const descriptions = [
        lText,
        `לרב ${lText}`,
        `במידה מסוימת ${lText}`,
        'באמצע',
        `במידה מסוימת ${rText}`,
        `לרב ${rText}`,
        rText,
      ];

      let currentStep = null;

      const stepsRow = document.createElement('div');
      stepsRow.className = 'flex justify-between items-center py-2';

      function updateSelection() {
        buttons.forEach((btn, idx) => {
          btn.classList.toggle('from-purple-600', idx === currentStep);
          btn.classList.toggle('to-indigo-600', idx === currentStep);
          btn.classList.toggle('bg-gradient-to-r', idx === currentStep);
          btn.classList.toggle('text-white', idx === currentStep);
          btn.classList.toggle('bg-gray-200', idx !== currentStep);
        });
        valueDisplay.textContent = currentStep !== null ? descriptions[currentStep] : '';
        submitBtn.disabled = currentStep === null;
        submitBtn.classList.toggle('opacity-50', currentStep === null);
        submitBtn.classList.toggle('cursor-not-allowed', currentStep === null);
      }

      const buttons = Array.from({length:7}, (_, idx) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'w-8 h-8 rounded-full bg-gray-200 transition';
        btn.setAttribute('aria-label', descriptions[idx]);
        btn.onclick = () => {
          currentStep = idx;
          updateSelection();
        };
        stepsRow.appendChild(btn);
        return btn;
      });

      container.append(stepsRow);

      const valueDisplay = document.createElement('div');
      valueDisplay.className = 'text-center text-xl font-bold text-purple-600';
      container.append(valueDisplay);

      const submitBtn = document.createElement('button');
      submitBtn.type = 'button';
      submitBtn.innerText = 'שלח תשובה';
      submitBtn.className = 'text-lg w-full py-3 px-6 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-xl opacity-50 cursor-not-allowed';
      submitBtn.disabled = true;
      submitBtn.onclick = async () => {
        if (currentStep === null) return;
        const leftCode  = data.options[0].code;
        const rightCode = data.options[1].code;
        const scaleMap = [ [12,0],[10,2],[8,4],[6,6],[4,8],[2,10],[0,12] ];
        const [lp, rp] = scaleMap[currentStep];
        await submitAnswer(questionNumber, null, null, {[leftCode]:lp,[rightCode]:rp});

      };
      
      container.append(submitBtn);

      document.getElementById('options').appendChild(container);
      updateSelection();
    }

    const sampleData = {
      options: [
        { text: 'לא מסכים כלל', code: 'low' },
        { text: 'מסכים מאוד', code: 'high' }
      ]
    };

    document.addEventListener('DOMContentLoaded', () => {
      renderScaleQuestion(sampleData, 1);
    });



    function renderRankingQuestion(data, questionNumber) {
    const container = document.createElement('div');
    container.className = 'glass-effect rounded-3xl shadow-lg p-8';

    // Enhanced instruction container with better styling
    const instructionContainer = document.createElement('div');
    instructionContainer.className = 'text-center mb-6';
    
    const mainInstruction = document.createElement('div');
    mainInstruction.className = 'text-purple-800 bg-gradient-to-r from-purple-50 to-indigo-50 px-6 py-4 rounded-2xl text-lg font-bold shadow-sm border border-purple-100 mb-3';
    mainInstruction.innerHTML = 'לחץ לפי סדר החשיבות';
    
    const subInstruction = document.createElement('div');
    subInstruction.className = 'text-purple-600 bg-purple-25 px-4 py-2 rounded-xl text-sm font-medium italic';
    subInstruction.innerHTML = 'לא בטוח? תמיד אפשר ללחוץ שוב ולשנות';
    
    instructionContainer.appendChild(mainInstruction);
    instructionContainer.appendChild(subInstruction);
    container.appendChild(instructionContainer);

    const list = document.createElement('ul');
    list.id = 'rankingList';
    list.className = 'space-y-3';

    const randomizedOptions = [...data.options].sort(() => Math.random() - 0.5);
    const selectedOrder = [];

    randomizedOptions.forEach(opt => {
        const li = document.createElement('li');
        li.className = 'ranking-item bg-white rounded-xl p-4 flex items-center gap-4 border cursor-pointer hover:shadow-md transition-all duration-200';
        li.setAttribute('data-code', opt.code);

        const numberDiv = document.createElement('span');
        numberDiv.className = 'ranking-number w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center font-bold text-gray-500';
        numberDiv.textContent = '?';

        const textSpan = document.createElement('span');
        textSpan.className = 'flex-1 text-gray-800';
        textSpan.textContent = opt.text;

        li.appendChild(numberDiv);
        li.appendChild(textSpan);

        li.addEventListener('click', () => {
            const code = opt.code;
            const idx = selectedOrder.indexOf(code);
            if (idx >= 0) {
                selectedOrder.splice(idx, 1);
            } else if (selectedOrder.length < 4) {
                selectedOrder.push(code);
            }
            renderRanks();
        });

        list.appendChild(li);
    });

    function renderRanks() {
        list.querySelectorAll('li').forEach(li => {
            const code = li.getAttribute('data-code');
            const numberDiv = li.querySelector('.ranking-number');
            const idx = selectedOrder.indexOf(code);
            if (idx >= 0) {
                numberDiv.textContent = idx + 1;
                numberDiv.className = 'ranking-number w-10 h-10 rounded-full bg-purple-400 text-white flex items-center justify-center font-bold selected';
                li.className = 'ranking-item bg-white rounded-xl p-4 flex items-center gap-4 border-2 border-purple-300 cursor-pointer shadow-md transition-all duration-200';
            } else {
                numberDiv.textContent = '?';
                numberDiv.className = 'ranking-number w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center font-bold text-gray-500';
                li.className = 'ranking-item bg-white rounded-xl p-4 flex items-center gap-4 border cursor-pointer hover:shadow-md transition-all duration-200';
            }
        });
    }

    container.appendChild(list);

    const buttons = document.createElement('div');
    buttons.className = 'flex gap-4 mt-8';

    const submitBtn = document.createElement('button');
    submitBtn.type = 'button';
    submitBtn.className = 'flex-1 py-4 px-6 bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-semibold rounded-xl hover:from-purple-700 hover:to-indigo-700 transform hover:scale-105 transition-all duration-200 shadow-lg';
    submitBtn.textContent = 'שלח דירוג';

    const errorDiv = document.createElement('div');
    errorDiv.id = 'rankingError';
    errorDiv.className = 'text-red-600 text-right mb-2 bg-red-50 border border-red-200 rounded-lg p-3 font-medium';
    errorDiv.style.display = 'none';
    document.getElementById('options').appendChild(errorDiv);

    submitBtn.onclick = async () => {
        if (selectedOrder.length < data.options.length) {
            errorDiv.textContent = 'יש לדרג את כל האפשרויות';
            errorDiv.style.display = 'block';
            return;
        } else {
            errorDiv.style.display = 'none';
            const result = {};
            selectedOrder.forEach((code, index) => {
                result[code] = index + 1;
            });
            await submitAnswer(questionNumber, null, null, result);
        }
    };

    const resetBtn = document.createElement('button');
    resetBtn.type = 'button';
    resetBtn.className = 'flex-1 py-4 px-6 bg-gradient-to-r from-violet-100 to-purple-100 text-purple-800 font-semibold rounded-xl hover:from-violet-200 hover:to-purple-200 transform hover:scale-105 transition-all duration-200 border border-purple-200';
    resetBtn.textContent = 'איפוס';

    resetBtn.onclick = () => {
        selectedOrder.length = 0;
        renderRanks();
    };

    buttons.appendChild(submitBtn);
    buttons.appendChild(resetBtn);

    container.appendChild(buttons);
    document.getElementById('options').appendChild(container);
}

async function submitAnswer(qNum, code, text, ranking = null) {
    const questionText = document.getElementById('questionText').innerText;
    const payload = { question_number: qNum, selected_option_code: code, selected_option_text: text, question: questionText };
    
    if (ranking) payload.ranking = ranking;
    try {
        await fetch('/pdn-diagnose/answer', {
            method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
        });
        // Store current question in history before moving to next
        questionHistory.push(currentQuestion);
        currentQuestion++; 
        loadQuestion(currentQuestion);
    } catch {
        alert('שגיאה בשליחת התשובה, אנא נסה שוב.');
    }
}

async function completeQuestionnaire() {
    const resp = await fetch('/pdn-diagnose/complete_questionnaire', { method: 'POST', headers: {'Content-Type':'application/json'} });
    if (resp.ok) window.location.href = '/pdn-diagnose/pdn_report'; else alert('שגיאה בסיום השאלון, אנא נסה שוב.');
}

async function goBack() {
    if (questionHistory.length > 0) {
        currentQuestion = questionHistory.pop();
        loadQuestion(currentQuestion);
    }
}


</script>
</body>
</html>
