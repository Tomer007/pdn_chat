<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8"/>
    <title>PDN Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&family=Varela+Round&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
      body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-family: 'Rubik', sans-serif; min-height: 100vh; }
      .glass-effect { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 1.5rem; box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
      @keyframes fadeInUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
      .fade-in { animation: fadeInUp 0.4s cubic-bezier(0.4,0,0.2,1) both; }
      .modal-backdrop {
        position: fixed; inset: 0; background: rgba(55, 48, 163, 0.3); display: none;
        align-items: center; justify-content: center; z-index: 50;
        animation: modalBackdropIn .4s both;
      }
      @keyframes modalBackdropIn { from { opacity: 0; } to { opacity: 1; } }
      .modal-animate {
        animation: modalScaleIn .45s cubic-bezier(0.4,0,0.2,1) both;
      }
      @keyframes modalScaleIn { from { opacity: 0; transform: scale(0.88) translateY(32px);} to { opacity: 1; transform: scale(1) translateY(0);} }
      .glow {
        box-shadow: 0 0 30px 0 #a5b4fc88, 0 2px 32px 0 #818cf880;
      }
      .modal-icon {
        font-size: 2.5rem;
        color: #7c3aed;
        filter: drop-shadow(0 2px 4px #818cf880);
        margin-bottom: 12px;
        animation: iconPop .6s cubic-bezier(0.68,-0.55,0.27,1.55);
      }
      @keyframes iconPop { 0% { transform: scale(0); } 70% { transform: scale(1.22); } 100% { transform: scale(1); } }
      .modal-close-btn {
        transition: background .22s, transform .15s;
      }
      .modal-close-btn:hover {
        background: linear-gradient(to left, #7c3aed 80%, #6366f1 100%);
        transform: scale(1.05) translateY(-2px);
        box-shadow: 0 2px 8px #a5b4fc44;
      }
      @media (max-width: 600px) {
        .glass-effect, .modal-card { padding: 1.2rem !important; }
      }
      /* Voice record UI */
      #voiceRecordArea .recording {
        color: #7c3aed;
        font-weight: bold;
        animation: pulse 1.1s infinite alternate;
      }
      @keyframes pulse { from { opacity: 1;} to { opacity: 0.5;} }
      .audio-bar {
        width: 8px; height: 22px; background: #7c3aed; margin: 0 2px; border-radius: 5px; display: inline-block; vertical-align: bottom;
        animation: bounce 1s infinite alternate;
      }
      .audio-bar:nth-child(2) { animation-delay: .15s; }
      .audio-bar:nth-child(3) { animation-delay: .3s; }
      .audio-bar:nth-child(4) { animation-delay: .45s; }
      .audio-bar:nth-child(5) { animation-delay: .6s; }
      @keyframes bounce {
        from { height: 8px; background: #c4b5fd; }
        to   { height: 22px; background: #7c3aed; }
      }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

<!-- Modal for stage instructions -->
<div id="instructionModal" class="fixed inset-0 bg-purple-800/40 backdrop-blur-sm hidden items-center justify-center z-50">
  <div class="relative bg-gradient-to-r from-purple-100 to-indigo-100 rounded-2xl p-8 max-w-md w-full glass-effect glow animate-fade-in-up shadow-2xl text-center">
    <!-- Animated bulb icon -->
    <div class="text-4xl mb-4 animate-bounce">💡</div>
    <!-- Title (if used) -->
    <h3 id="modalTitle" class="text-lg font-extrabold mb-2" style="font-family:'Varela Round',cursive"></h3>
    <!-- Instruction text -->
    <p id="modalText" class="text-lg text-right text-gray-800 whitespace-pre-line mb-6 leading-relaxed"></p>
    <!-- Action button -->
    <button id="modalClose" class="mx-auto block py-3 px-8 text-lg bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg font-semibold shadow-lg hover:shadow-2xl focus:outline-none focus:ring-4 focus:ring-purple-400/30 transform transition duration-300 hover:scale-105 animate-pulse">
      יופי, אפשר להתקדם!
    </button>
  </div>
</div>

<style>
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(24px);}
    to { opacity: 1; transform: translateY(0);}
  }
  .animate-fade-in-up {
    animation: fadeInUp 0.5s cubic-bezier(0.4,0,0.2,1) both;
  }
  @keyframes bounce {
    0%, 100% { transform: translateY(0);}
    50% { transform: translateY(-10px);}
  }
  .animate-bounce {
    animation: bounce 1.2s infinite;
  }
  @keyframes pulse {
    0% { transform: scale(1);}
    50% { transform: scale(1.05);}
    100% { transform: scale(1);}
  }
  .animate-pulse {
    animation: pulse 2s infinite;
  }
</style>


<main id="chatArea" class="glass-effect p-8 rounded-2xl shadow-2xl w-full max-w-2xl border border-white/20 space-y-6">
    <h1 class="text-4xl font-bold text-center text-gray-800 bg-gradient-to-r from-purple-600 to-indigo-600 bg-clip-text text-transparent">אבחון צופן המקור </h1>
    <div id="messages" class="space-y-4 fade-in">
        <!-- Welcome Message -->
        <!-- <div id="welcomeMessage" class="p-6 rounded-xl border border-indigo-100 bg-gradient-to-r from-purple-100 to-indigo-100 text-gray-800 shadow-sm fade-in text-right" dir="rtl">
          <p class="text-lg mb-4 ">שלום וברוך הבא,</p>
          <p class="text-lg mb-4">בוא נגלה יחד את קוד המקור הייחודי שלך, המצפן הפנימי שלך לצמיחה והתפתחות.</p>
          <p class="text-lg mb-4">תענה בלב פתוח ובכנות ונצא למסע מרתק פנימה</p>

        </div> -->
        <!-- Voice Recording Section -->
        <div id="voiceRecordArea" class="p-6 rounded-xl border border-indigo-100 bg-gradient-to-r from-purple-100 to-indigo-100 text-gray-800 shadow-sm fade-in text-right" dir="rtl">
          <p class="text-lg mb-4 ">שלום וברוך הבא,</p>
          <p class="text-lg mb-4">בוא נגלה יחד את קוד המקור הייחודי שלך, המצפן הפנימי שלך לצמיחה והתפתחות.</p>
          <p class="text-lg mb-4" >הקלט דקה של דיבור – זה עוזר לנו לשפר את הדיוק של קוד המקור שלך</p>
          <p class="text-lg mb-4">לחץ על כפתור ההקלטה, דבר בחופשיות או ספר קצת על עצמך, וכשתסיים לחץ על "סיים".</p>
          <p class="text-lg mb-4">ההקלטה לא חובה, אבל זה משפר את דיוק קוד המקור שלך!</p>
            <div>
                <button id="startRecordBtn" class="text-lg py-3 px-7 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl shadow-lg font-semibold">התחל להקליט</button>
                <button id="skipBtn" class="text-lg py-3 px-7 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl shadow-lg font-semibold">דלג, אתחל איבחון</button>
                <button id="stopRecordBtn" class="hidden text-lg py-3 px-7 bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-xl shadow-lg font-semibold ml-2">סיים</button>
            </div>
            <div id="recordStatus" class="text-lg text-purple-700"></div>
            <div id="visualizer" class="flex justify-center items-end space-x-1 mb-1" style="height:24px;direction:ltr"></div>
            <audio id="audioPlayback" controls class="hidden mx-auto" style="max-width:260px"></audio>
        </div>
    </div>
    <div id="questionArea" class="hidden space-y-6">
        <h2 id="questionText" class="text-lg font-semibold text-gray-700 mb-4 bg-gradient-to-r from-purple-600 to-indigo-600 bg-clip-text text-transparent"></h2>
        <div id="options" class="space-y-3"></div>
    </div>

    <!-- Footer Link -->
    <div class="text-center pt-4 space-y-4">
        <button id="backButton" onclick="goBack()" class="text-sm w-1/2 py-2 px-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-medium rounded-xl hover:from-purple-700 hover:to-indigo-700 focus:outline-none focus:ring-4 focus:ring-purple-500/50 transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98] shadow-lg hidden">
            חזור לשאלה הקודמת
        </button>
        <p class="text-sm sm:text-base font-medium bg-gradient-to-r from-purple-600 via-pink-500 to-indigo-500 bg-clip-text text-transparent animate-pulse">
            ✨ <a href="https://www.pdn.co.il" target="_blank" class="hover:underline">PDN – הנווט החכם להתפתחות
            אישית</a> ✨
        </p>
    </div>

</main>

<script>
let currentQuestion = 1;
let currentStage = '';
let nextData = null;
let questionHistory = []; // Array to store question history

// Modal logic
const modal = document.getElementById('instructionModal');
const modalTitle = document.getElementById('modalTitle');
const modalText = document.getElementById('modalText');
document.getElementById('modalClose').onclick = () => {
    modal.style.display = 'none';
    document.body.style.overflow = "";
    if (nextData) { actuallyRenderQuestion(nextData); nextData = null; }
};

// Voice record logic
let mediaRecorder;
let audioChunks = [];
let recordTimer = null;
let recordElapsed = 0;

const startBtn = document.getElementById('startRecordBtn');
const stopBtn = document.getElementById('stopRecordBtn');
const recordStatus = document.getElementById('recordStatus');
const audioPlayback = document.getElementById('audioPlayback');
const visualizer = document.getElementById('visualizer');
const skipBtn = document.getElementById('skipBtn');


skipBtn.onclick = async function() {    
    document.getElementById('voiceRecordArea').classList.add('hidden');
    document.getElementById('questionArea').classList.remove('hidden');
    resetVoiceUI();
    loadQuestion(currentQuestion);
};

startBtn.onclick = async function() {
    audioChunks = [];
    recordStatus.innerHTML = '<span class="recording">מקליט... (00:00 / 01:00)</span>';
    startBtn.classList.add('hidden');
    stopBtn.classList.remove('hidden');
    audioPlayback.classList.add('hidden');
    skipBtn.classList.add('hidden');
    visualizer.innerHTML = '';
    // Add fake bars for animation
    for(let i=0;i<5;i++){
        const bar = document.createElement('div');
        bar.className = 'audio-bar';
        visualizer.appendChild(bar);
    }
    recordElapsed = 0;
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = e => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            audioPlayback.src = URL.createObjectURL(audioBlob);
            audioPlayback.classList.remove('hidden');
            visualizer.innerHTML = '';
        };
        mediaRecorder.start();
        // Timer for duration
        recordTimer = setInterval(() => {
            recordElapsed++;
            let sec = recordElapsed % 60, min = Math.floor(recordElapsed / 60);
            recordStatus.innerHTML = `<span class="recording">מקליט... (${("0"+min).slice(-2)}:${("0"+sec).slice(-2)} / 01:00)</span>`;
            if(recordElapsed >= 60) {
                finishRecording();
            }
        }, 1000);
    } catch (err) {
        recordStatus.innerHTML = '<span class="text-red-600 font-semibold">שגיאה בגישה למיקרופון</span>';
        stopBtn.classList.add('hidden');
        startBtn.classList.remove('hidden');
        visualizer.innerHTML = '';
    }
};

function finishRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        clearInterval(recordTimer);
        recordStatus.innerHTML = '<span class="text-black-600 font-bold">ההקלטה הסתיימה.</span>';
        stopBtn.innerText = 'המשך';
        stopBtn.classList.remove('hidden');
        startBtn.classList.add('hidden');
        skipBtn.classList.add('hidden');
        visualizer.innerHTML = '';
    }
}

stopBtn.onclick = function() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        finishRecording();
    } else {
        document.getElementById('voiceRecordArea').classList.add('hidden');
        document.getElementById('questionArea').classList.remove('hidden');
        loadQuestion(currentQuestion);
    }
};

function resetVoiceUI() {
    startBtn.classList.remove('hidden');
    stopBtn.classList.add('hidden');
    stopBtn.innerText = 'סיים והמשך';
    recordStatus.innerHTML = '';
    audioPlayback.classList.add('hidden');
    audioPlayback.src = '';
    visualizer.innerHTML = '';
    if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
    if (recordTimer) clearInterval(recordTimer);
}

// Question/Modal logic
async function loadQuestion(questionNumber) {
    const response = await fetch(`/questionnaire/${questionNumber}`);
    const data = await response.json();
    if (data.message === "No more questions.") return completeQuestionnaire();
    if (data.stage !== currentStage) {
        currentStage = data.stage;
        if (data.instructions) {
          //<div id="voiceRecordArea" class="p-6 rounded-xl border border-indigo-100 bg-gradient-to-r from-purple-100 to-indigo-100 text-gray-800 shadow-sm fade-in text-right" dir="rtl">

            //modalTitle.innerHTML = "<div class=' p-6 text-lg font-bold text-gray-700 ' >הסבר:</div>";
            modalText.innerText = data.instructions;
            modal.style.display = 'flex';
            document.body.style.overflow = "hidden";
            setTimeout(() => {
                modal.classList.remove('modal-animate');
                void modal.offsetWidth; // Force reflow
                modal.classList.add('modal-animate');
            }, 10);
            nextData = data;
            return;
        }
    }
    actuallyRenderQuestion(data);
}

function actuallyRenderQuestion(data) {
    document.getElementById('questionText').innerText = data.question;
    const optionsDiv = document.getElementById('options');
    optionsDiv.innerHTML = '';
    
    // Show/hide back button based on question history
    const backButton = document.getElementById('backButton');
    backButton.classList.toggle('hidden', questionHistory.length === 0);

    if (['PartC','PartD'].includes(data.stage)) {
        renderSliderQuestion(data, data.question_number);
        return;
    }
    if (data.type === 'ranking') {
        renderRankingQuestion(data, data.question_number);
        return;
    }
    
    // Create an array of buttons first
    const buttons = data.options.map(opt => {
        const btn = document.createElement('button');
        btn.innerText = opt.text;
        btn.className = 'text-lg fade-in w-full py-4 px-6 bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-medium rounded-xl hover:from-purple-700 hover:to-indigo-700 focus:outline-none focus:ring-4 focus:ring-purple-500/50 transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98] shadow-lg';
        btn.onclick = () => submitAnswer(data.question_number, opt.code, opt.text);
        return btn;
    });
    
    // Randomize the order of buttons
    buttons.sort(() => Math.random() - 0.5);
    
    // Append the randomized buttons to the options div
    buttons.forEach(btn => optionsDiv.appendChild(btn));
}

function renderSliderQuestion(data, questionNumber) {
    const sliderContainer = document.createElement('div');
    sliderContainer.className = 'space-y-4';
    // Labels
    const labelsContainer = document.createElement('div');
    labelsContainer.className = 'flex justify-between text-sm text-gray-600';
    const leftContainer = document.createElement('div'); leftContainer.className = 'flex items-center gap-2';
    const leftLabel = document.createElement('span'); leftLabel.textContent = data.options[0].text; leftLabel.className = 'text-right';
    const leftButton = document.createElement('button'); leftButton.innerHTML = '&#8594;'; leftButton.className = 'w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center';
    leftButton.onclick = () => { if (slider.value > 1) { slider.value--; slider.dispatchEvent(new Event('input')); } };
    leftContainer.append(leftButton, leftLabel);

    const rightContainer = document.createElement('div'); rightContainer.className = 'flex items-center gap-2';
    const rightButton = document.createElement('button'); rightButton.innerHTML = '&#8592;'; rightButton.className = 'w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center';
    rightButton.onclick = () => { if (slider.value < 7) { slider.value++; slider.dispatchEvent(new Event('input')); } };
    const rightLabel = document.createElement('span'); rightLabel.textContent = data.options[1].text; rightLabel.className = 'text-left';
    rightContainer.append(rightButton, rightLabel);
    labelsContainer.append(leftContainer, rightContainer);

    // Slider
    const slider = document.createElement('input');
    slider.type = 'range'; slider.min = '1'; slider.max = '7'; slider.value = '4'; slider.className = 'w-full';
    const valueDisplay = document.createElement('div'); valueDisplay.className = 'text-center text-sm text-gray-600'; valueDisplay.textContent = 'באמצע';
    slider.addEventListener('input', e => {
        const v = +e.target.value;
        const [lText, rText] = data.options.map(o=>o.text);
        let desc;
        if (v===1) desc = lText;
        else if (v===2) desc = `לרב ${lText}`;
        else if (v===3) desc = `במידה מסוימת ${lText}`;
        else if (v===4) desc = 'באמצע';
        else if (v===5) desc = `במידה מסוימת ${rText}`;
        else if (v===6) desc = `לרב ${rText}`;
        else if (v===7) desc = rText;
        valueDisplay.textContent = desc;
    });
    // Submit
    const submitBtn = document.createElement('button');
    submitBtn.type = 'button';
    submitBtn.innerText = 'שלח תשובה';
    submitBtn.className = 'text-lg w-full py-3 px-6 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-xl';
    submitBtn.onclick = async () => {
        const v = +slider.value;
        const leftCode = data.options[0].code, rightCode = data.options[1].code;
        let lp, rp;
        switch(v){case 1: lp=12;rp=0;break;case 2:lp=10;rp=2;break;case 3:lp=8;rp=4;break;case 4:lp=6;rp=6;break;case 5:lp=4;rp=8;break;case 6:lp=2;rp=10;break;case 7:lp=0;rp=12;break;}
        await submitAnswer(questionNumber, null, null, {[leftCode]:lp,[rightCode]:rp});
    };
    // Assemble
    sliderContainer.append(labelsContainer, slider, valueDisplay, submitBtn);
    document.getElementById('options').appendChild(sliderContainer);
}

function renderRankingQuestion(data, questionNumber) {
    const list = document.createElement('ul'); 
    list.id = 'rankingList'; 
    list.className = 'space-y-2';
    
    // Create an array of options and randomize them
    const randomizedOptions = [...data.options].sort(() => Math.random() - 0.5);
    
    // Use the randomized options to create list items
    randomizedOptions.forEach(opt => {
        const item = document.createElement('li');
        item.className = 'cursor-move bg-white border border-indigo-200 rounded-lg px-4 py-3 shadow flex items-center text-gray-800 font-medium';
        item.setAttribute('data-code', opt.code);
        item.innerText = opt.text;
        list.appendChild(item);
    });
    Sortable.create(list, { animation: 150 });
    document.getElementById('options').appendChild(list);
    
    const submitBtn = document.createElement('button');
    submitBtn.type = 'button';
    submitBtn.innerText = 'שלח דירוג';
    submitBtn.className = 'text-lg w-full py-3 px-6 mt-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-medium rounded-xl';
    submitBtn.onclick = async e => {
        e.preventDefault(); 
        const items = list.querySelectorAll('li'); 
        const ranking = {};
        items.forEach((it, idx) => ranking[it.getAttribute('data-code')] = idx+1);
        await submitAnswer(questionNumber, null, null, ranking);
    };
    document.getElementById('options').appendChild(submitBtn);
}

async function submitAnswer(qNum, code, text, ranking = null) {
    const payload = { question_number: qNum, selected_option_code: code, selected_option_text: text };
    if (ranking) payload.ranking = ranking;
    try {
        await fetch('/answer', {
            method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
        });
        // Store current question in history before moving to next
        questionHistory.push(currentQuestion);
        currentQuestion++; 
        loadQuestion(currentQuestion);
    } catch {
        alert('שגיאה בשליחת התשובה, אנא נסה שוב.');
    }
}

async function completeQuestionnaire() {
    const resp = await fetch('/complete_questionnaire', { method: 'POST', headers: {'Content-Type':'application/json'} });
    if (resp.ok) window.location.href = '/pdn_report'; else alert('שגיאה בסיום השאלון, אנא נסה שוב.');
}

async function goBack() {
    if (questionHistory.length > 0) {
        currentQuestion = questionHistory.pop();
        loadQuestion(currentQuestion);
    }
}
</script>
</body>
</html>
