<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com data:; img-src 'self' data:; connect-src 'self';">
    <title>בינת קוד המקור - שיחה עם הנווט הפנימי</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="/static/js/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary-color: #1c0f97;
            --secondary-color: #1c0f97;
            --accent-color: #1c0f97;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --gradient-start: #0b2e6b;
            --gradient-end: #0b2e6b;
        }

        /* Dark mode variables */
        [data-theme="dark"] {
            --primary-color: #3570d7;
            --secondary-color: #3570d7;
            --accent-color: #3570d7;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --bg-primary: #1f2937;
            --bg-secondary: #111827;
            --border-color: #374151;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --gradient-start: #3570d7;
            --gradient-end: #3570d7;
        }

        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; 
            background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            direction: rtl;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        /* Smooth transition between header and body */
        .header-gradient {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 50%, var(--accent-color) 100%);
            position: relative;
            overflow: hidden;
        }

        .header-gradient::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 20px;
            background: linear-gradient(to bottom, transparent, rgba(224, 231, 255, 0.8));
        }

        /* Enhanced chat container */
        .chat-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 24px;
            max-width: 900px;
            width: 100%;
            box-shadow: 0 20px 40px var(--shadow-color);
            display: flex;
            flex-direction: column;
            animation: fadeIn 1s ease-in-out;
            transition: all 0.4s ease;
            min-height: 600px;
            overflow-y: auto;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.2);
            scroll-behavior: smooth;
        }

        [data-theme="dark"] .chat-container {
            background: rgba(31, 41, 55, 0.95);
            border: 1px solid rgba(55, 65, 81, 0.3);
        }

        /* Enhanced chat bubbles with improved readability and user-friendly colors */
        .chat-bubble {
            border-radius: 20px;
            padding: 16px 20px;
            margin-bottom: 16px;
            font-size: 16px;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            animation: slideIn 0.5s ease;
            max-width: 80%;
            position: relative;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px var(--shadow-color);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .chat-bubble.user {
            background: #0b2e6b;
            color: #ffffff;
            align-self: flex-end;
            border-bottom-right-radius: 8px;
            border: 1px solid rgba(53, 112, 215, 0.3);
        }

        [data-theme="dark"] .chat-bubble.user {
            background: #0b2e6b;
            color: #ffffff;
            border: 1px solid rgba(53, 112, 215, 0.4);
        }

        .chat-bubble.bot {
            background: #dcdfe9;
            color: #181818;
            align-self: flex-start;
            border-bottom-left-radius: 8px; 
        }

        [data-theme="dark"] .chat-bubble.bot {
            background: #e97b3b;
            color: #ffffff;
        }


        /* Enhanced input area */
        .input-area {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 0 4px 16px var(--shadow-color);
            border: 1px solid rgba(255, 255, 255, 0.3);
            margin-top: 20px;
        }

        [data-theme="dark"] .input-area {
            background: rgba(31, 41, 55, 0.9);
            border: 1px solid rgba(55, 65, 81, 0.3);
        }

        .input-area input {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            font-size: 16px;
            padding: 12px 16px;
            border-radius: 16px;
            color: var(--text-primary);
            direction: rtl;
        }

        .input-area input::placeholder {
            color: var(--text-secondary);
            font-style: italic;
        }

        .send-button {
            background: #0b2e6b;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(11, 46, 107, 0.3);
        }

        .send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(11, 46, 107, 0.4);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Attachment and mic buttons */
        .action-button {
            background: #0b2e6b;
            border: 1px solid rgba(11, 46, 107, 0.2);
            color: #ffffff;
            padding: 10px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        [data-theme="dark"] .action-button {
            background: #0b2e6b;
            border: 1px solid rgba(11, 46, 107, 0.2);
            color: #ffffff;
        }

        .action-button:hover {
            background: #0a2a5f;
            transform: scale(1.05);
        }

        /* Typing indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background:  #8ea4ed;
            border-radius: 16px;
            color: #ffffff;
            font-size: 14px;
            animation: pulse 2s infinite;
            max-width: 200px;
            margin-bottom: 16px;
            border: 1px solid #8ea4ed;
            box-shadow: 0 2px 8px #8ea4ed;
        }

        [data-theme="dark"] .typing-indicator {
            background: #e97b3b;
            color: #ffffff;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        /* Recording indicator */
        .recording-indicator {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 16px;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-radius: 16px;
            color: #dc2626;
            font-size: 14px;
            animation: pulse 2s infinite;
            max-width: 400px;
            margin-bottom: 16px;
            border: 2px solid rgba(220, 38, 38, 0.2);
        }

        [data-theme="dark"] .recording-indicator {
            background: linear-gradient(135deg, #450a0a 0%, #7f1d1d 100%);
            color: #fca5a5;
            border: 2px solid rgba(252, 165, 165, 0.2);
        }

        .recording-indicator .recording-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .recording-indicator .recording-time {
            background: rgba(220, 38, 38, 0.1);
            padding: 4px 8px;
            border-radius: 8px;
            font-family: monospace;
            font-weight: bold;
        }

        .recording-indicator .transcription-text {
            margin-top: 8px;
            font-size: 14px;
            line-height: 1.4;
            color: #6b7280;
            max-height: 100px;
            overflow-y: auto;
            padding: 8px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 8px;
        }

        [data-theme="dark"] .recording-indicator .transcription-text {
            background: rgba(0, 0, 0, 0.3);
            color: #d1d5db;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            background: currentColor;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        /* Quick reply buttons */
        .quick-replies {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .quick-reply-btn {
            background: linear-gradient(135deg, #0b2e6b 0%, #0a2a5f 100%);
            border: 1px solid rgba(11, 46, 107, 0.3);
            color: #ffffff;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(11, 46, 107, 0.1);
        }

        [data-theme="dark"] .quick-reply-btn {
            background: linear-gradient(135deg, #0b2e6b 0%, #0a2a5f 100%);
            border: 1px solid rgba(11, 46, 107, 0.3);
            color: #ffffff;
        }

        .quick-reply-btn:hover {
            background: linear-gradient(135deg, #0a2a5f 0%, #092a5a 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(11, 46, 107, 0.2);
        }

        [data-theme="dark"] .quick-reply-btn:hover {
            background: linear-gradient(135deg, #0a2a5f 0%, #092a5a 100%);
        }

        /* Message headers */
        .message-header {
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 6px;
            opacity: 0.9;
            letter-spacing: 0.5px;
        }

        .chat-bubble.user .message-header {
            color: #ffffff;
            font-weight: 700;
        }

        .chat-bubble.bot .message-header {
            color: #000000;
            font-weight: 700;
        }

        [data-theme="dark"] .chat-bubble.bot .message-header {
            color: #000000;
            font-weight: 700;
        }


        [data-theme="dark"] .chat-bubble.bot .message-header {
            color: #ffffff;
            font-weight: 700;
        }

        /* Message timestamps */
        .message-time {
            font-size: 11px;
            margin-top: 6px;
            opacity: 0.7;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-align: left;
        }

        .chat-bubble.user .message-time {
            color: #ffffff;
            text-align: left;
            font-weight: 700;
        }

        [data-theme="dark"] .chat-bubble.user .message-time {
            color: #000000;
            text-align: left;
            font-weight: 700;
        }

        .chat-bubble.bot .message-time {
            color: #000000;
            text-align: left;
            font-weight: 700;
        }

        [data-theme="dark"] .chat-bubble.bot .message-time {
            color: #000000;
            text-align: left;
            font-weight: 700;
        }

        /* Theme toggle */
        .theme-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #0b2e6b;
            border: 1px solid rgba(11, 46, 107, 0.2);
            color: #ffffff;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        [data-theme="dark"] .theme-toggle {
            background: #0b2e6b;
            border: 1px solid rgba(11, 46, 107, 0.2);
        }

        .theme-toggle:hover {
            background: #0a2a5f;
            transform: scale(1.1);
        }

        /* Export button */
        .export-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #0b2e6b;
            border: 1px solid rgba(11, 46, 107, 0.2);
            color: #ffffff;
            padding: 10px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
            font-size: 14px;
        }

        [data-theme="dark"] .export-button {
            background: #0b2e6b;
            border: 1px solid rgba(11, 46, 107, 0.2);
            color: #ffffff;
        }

        .export-button:hover {
            background: #0a2a5f;
            transform: translateY(-1px);
        }

        /* Header layout improvements */
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo-link {
            cursor: pointer;
            transition: transform 0.2s ease;
            display: block;
        }

        .logo-link:hover {
            transform: scale(1.05);
        }

        .header-logo {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            border: 4px solid rgba(255,255,255,0.3);
        }

        .header-text {
            text-align: right;
        }

        /* Improved logout button */
        .logout-button {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 20px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            min-height: 48px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .logout-button:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .logout-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .logout-button:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3), 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .logout-button i {
            font-size: 18px;
        }

        .logout-text {
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        /* Error message styling */
        .error-message {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            color: #dc2626;
            border: 1px solid #fecaca;
            border-radius: 12px;
            padding: 12px 16px;
            margin: 8px 0;
            font-size: 14px;
        }

        [data-theme="dark"] .error-message {
            background: linear-gradient(135deg, #450a0a 0%, #7f1d1d 100%);
            color: #fca5a5;
            border: 1px solid #991b1b;
        }

        /* Success message styling */
        .success-message {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            color: #16a34a;
            border: 1px solid #bbf7d0;
            border-radius: 12px;
            padding: 12px 16px;
            margin: 8px 0;
            font-size: 14px;
        }

        [data-theme="dark"] .success-message {
            background: linear-gradient(135deg, #052e16 0%, #14532d 100%);
            color: #86efac;
            border: 1px solid #166534;
        }

        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* File upload area */
        .file-upload-area {
            display: none;
            padding: 16px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px dashed rgba(99, 102, 241, 0.3);
            border-radius: 12px;
            margin: 8px 0;
            text-align: center;
            color: var(--text-secondary);
        }

        [data-theme="dark"] .file-upload-area {
            background: rgba(31, 41, 55, 0.9);
            border: 2px dashed rgba(129, 140, 248, 0.3);
        }

        .file-upload-area.dragover {
            border-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.1);
        }

        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .chat-container {
                margin: 10px;
                padding: 16px;
                border-radius: 16px;
            }

            .chat-bubble {
                max-width: 90%;
                font-size: 15px;
                padding: 12px 16px;
            }

            .input-area {
                padding: 12px;
                gap: 8px;
            }

            .input-area input {
                font-size: 15px;
                padding: 10px 12px;
            }

            .send-button {
                padding: 10px 16px;
                font-size: 14px;
            }

            .theme-toggle, .export-button {
                top: 10px;
                padding: 8px;
            }

            .theme-toggle {
                left: 10px;
            }

            .export-button {
                right: 10px;
                padding: 8px 12px;
                font-size: 12px;
            }

            /* Mobile header layout */
            .header-content {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }

            .header-left {
                flex-direction: column;
                gap: 12px;
            }

            .header-text {
                text-align: center;
            }

            .logout-button {
                padding: 10px 16px;
                font-size: 13px;
                min-height: 44px;
            }
            
            .logout-text {
                display: block;
            }
            
            .logout-button i {
                font-size: 16px;
            }
        }

        /* Accessibility improvements */
        .chat-bubble:focus-within {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .input-area input:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .chat-bubble {
                border: 2px solid #000;
            }
            
            .input-area {
                border: 2px solid #000;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            .chat-bubble, .send-button, .action-button {
                animation: none;
                transition: none;
            }
        }

        /* Screen reader only text */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Custom confirmation modal 1 */
        .confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .confirmation-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .confirmation-content {
            background: #ffffff;
            border-radius: 24px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(0, 0, 0, 0.1);
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .confirmation-modal.show .confirmation-content {
            transform: scale(1) translateY(0);
        }

        .confirmation-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: #0b2e6b;
        }

        .confirmation-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 28px;
            color: #d97706;
            box-shadow: 0 8px 20px rgba(217, 119, 6, 0.2);
        }

        [data-theme="dark"] .confirmation-icon {
            background: linear-gradient(135deg, #451a03 0%, #78350f 100%);
            color: #fbbf24;
        }

        .confirmation-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #000000;
            margin-bottom: 12px;
            line-height: 1.3;
        }

        .confirmation-message {
            font-size: 1rem;
            color: #333333;
            line-height: 1.6;
            margin-bottom: 32px;
        }

        .confirmation-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .confirmation-btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            min-width: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .confirmation-btn.cancel {
            background: #0b2e6b;
            color: #ffffff;
            border: 1px solid rgba(11, 46, 107, 0.2);
        }

        .confirmation-btn.cancel:hover {
            background: #0a2a5f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(11, 46, 107, 0.3);
        }

        .confirmation-btn.confirm {
            background: #0b2e6b;
            color: white;
            box-shadow: 0 4px 12px rgba(11, 46, 107, 0.3);
        }

        .confirmation-btn.confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(11, 46, 107, 0.4);
        }

        .confirmation-btn:active {
            transform: translateY(0);
        }

        [data-theme="dark"] .confirmation-btn.cancel {
            background: #0b2e6b;
            color: #ffffff;
            border: 1px solid rgba(11, 46, 107, 0.2);
        }

        [data-theme="dark"] .confirmation-btn.cancel:hover {
            background: #0a2a5f;
        }

        /* Mobile responsiveness for confirmation modal */
        @media (max-width: 768px) {
            .confirmation-content {
                padding: 24px;
                margin: 20px;
            }

            .confirmation-icon {
                width: 56px;
                height: 56px;
                font-size: 24px;
                margin-bottom: 16px;
            }

            .confirmation-title {
                font-size: 1.25rem;
            }

            .confirmation-message {
                font-size: 0.9rem;
                margin-bottom: 24px;
            }

            .confirmation-buttons {
                flex-direction: column;
                gap: 8px;
            }

            .confirmation-btn {
                width: 100%;
                padding: 14px 20px;
            }
        }

        /* Recording microphone button */
        .action-button.recording {
            background: linear-gradient(135deg, #0b2e6b 0%, #0a2a5f 100%);
            border-color: #0b2e6b;
            animation: pulse 1.5s ease-in-out infinite;
            box-shadow: 0 0 20px rgba(11, 46, 107, 0.5);
        }

        .action-button.recording:hover {
            background: linear-gradient(135deg, #0a2a5f 0%, #092a5a 100%);
            transform: scale(1.05);
        }

        .action-button.recording i {
            color: white;
        }

        /* Recording indicator animation */
        @keyframes recordingPulse {
            0%, 100% {
                box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 30px rgba(239, 68, 68, 0.8);
                transform: scale(1.05);
            }
        }

        .action-button.recording {
            animation: recordingPulse 1.5s ease-in-out infinite;
        }

        /* Transcription feedback */
        .transcription-feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #0b2e6b;
            border: 1px solid rgba(11, 46, 107, 0.2);
            color: #ffffff;
            padding: 16px 24px;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 80vw;
            text-align: center;
        }

        .transcription-feedback.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        [data-theme="dark"] .transcription-feedback {
            background: #0b2e6b;
            border: 1px solid rgba(11, 46, 107, 0.2);
            color: #ffffff;
        }
    </style>
</head>
<body>
    <!-- Theme toggle -->
    <button class="theme-toggle" onclick="toggleTheme()" title="החלף ערכת נושא" aria-label="החלף ערכת נושא">
        <i class="fas fa-moon"></i>
    </button>

    <!-- Export button -->
    <button class="export-button" onclick="exportChat()" title="ייצא שיחה" aria-label="ייצא שיחה">
        <i class="fas fa-download"></i> ייצא
    </button>

    <!-- Floating logout button (below export and theme toggle) -->
    <button class="floating-logout-button" onclick="handleThankYouClick()" title="סיים שיחה וחזור להתחברות" aria-label="סיים שיחה וחזור להתחברות">
        <i class="fas fa-sign-out-alt"></i>
        סיים שיחה
    </button>

    <style>
        .floating-logout-button {
            position: fixed;
            top: 70px;
            right: 20px;
            background: #0b2e6b;
            border: 1px solid rgba(11, 46, 107, 0.2);
            color: #ffffff;
            padding: 10px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }
        [data-theme="dark"] .floating-logout-button {
            background: #0b2e6b;
            border: 1px solid rgba(11, 46, 107, 0.2);
            color: #ffffff;
        }
        .floating-logout-button:hover {
            background: #0a2a5f;
            transform: translateY(-1px);
        }
        .floating-logout-button i {
            font-size: 16px;
        }
        @media (max-width: 768px) {
            .floating-logout-button {
                top: 60px;
                right: 12px;
                padding: 10px 12px;
                font-size: 13px;
            }
        }
    </style>

    <!-- Header with improved layout -->
    <header >
        <div class="header-content">
            <!-- Logo and title section -->
            <div class="header-left">
                <a href="https://www.pdn.co.il" target="_blank" class="logo-link">
                    <img src="/static/images/pdn_logo.png" alt="PDN Logo" class="header-logo" />
                </a>
                <div class="header-text">
                    <h1 class="text-2xl font-bold mb-2 text-white">בינת קוד המקור</h1>
                    <p class="text-2xl opacity-90 text-white ">שיחה עם הנווט הפנימי</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main container -->
    <div class="container mx-auto p-6 max-w-4xl">
        <div class="chat-container" id="chatContainer">
            <!-- Chat messages will be inserted here -->
        </div>

        <!-- Enhanced input area -->
        <div class="input-area">
            <input type="text" id="userInput" 
                   placeholder="כתוב לי עכשיו..." 
                   lang="he-IL"
                   onkeydown="handleKeyPress(event)"
                   aria-label="הודעת טקסט" />
            
            <button class="action-button" onclick="toggleMicrophone()" title="הקלטה קולית" id="micBtn" aria-label="הקלטה קולית">
                <i class="fas fa-microphone"></i>
            </button>
            
            <button class="send-button" onclick="sendMessage()" id="sendBtn" aria-label="שלח הודעה">
                <i class="fas fa-paper-plane"></i> שלח
            </button>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div class="confirmation-modal" id="confirmationModal">
        <div class="confirmation-content">
            <h3 class="confirmation-title">סיים שיחה</h3>
            <p class="confirmation-message">האם אתה בטוח שברצונך לסיים את השיחה ולחזור לדף ההתחברות?</p>
            <p class="confirmation-message">שים לב: השיחה לא תישמר. אם ברצונך לשמור את תוכן השיחה, אנא ייצא אותה לפני היציאה.</p>
            <div class="confirmation-buttons">
                <button class="confirmation-btn cancel" onclick="hideConfirmationModal()">
                    <i class="fas fa-times"></i>
                    ביטול
                </button>
                <button class="confirmation-btn confirm" onclick="confirmLogout()">
                    <i class="fas fa-check"></i>
                    אישור
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        const USER_NAME = "{{ user_name }}";
        const USER_ID = "{{ user_id }}";
        let isDarkMode = false;
        let messageQueue = [];
        let isProcessing = false;
        
        // Voice recording variables
        let speechRecognition = null;
        let isListening = false;
        let finalTranscript = '';
        let interimTranscript = '';

        // Utility functions
        function getCurrentTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        // Initialize Web Speech API
        function initializeSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                console.warn('Speech recognition not supported');
                return null;
            }

            const recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'he-IL'; // Hebrew language
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                isListening = true;
                finalTranscript = '';
                interimTranscript = '';
                updateMicrophoneUI(true);
                showTranscriptionFeedback('🎤 מקשיב...');
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                // Update the input field with real-time transcription
                const userInput = document.getElementById('userInput');
                userInput.value = finalTranscript + interimTranscript;
                
                // Show real-time feedback
                if (interimTranscript) {
                    showTranscriptionFeedback(`🎤 מקשיב... "${interimTranscript}"`);
                } else if (finalTranscript) {
                    showTranscriptionFeedback(`✅ הושלם: "${finalTranscript}"`);
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                isListening = false;
                updateMicrophoneUI(false);
                hideTranscriptionFeedback();
                
                let errorMessage = 'שגיאה בהקלטה';
                switch (event.error) {
                    case 'no-speech':
                        errorMessage = 'לא זוהתה דיבור';
                        break;
                    case 'audio-capture':
                        errorMessage = 'בעיה במיקרופון';
                        break;
                    case 'not-allowed':
                        errorMessage = 'אין הרשאה למיקרופון';
                        break;
                    case 'network':
                        errorMessage = 'בעיית רשת';
                        break;
                }
                showError(errorMessage);
            };

            recognition.onend = () => {
                isListening = false;
                updateMicrophoneUI(false);
                hideTranscriptionFeedback();
                
                // If we have final transcript, send the message
                const userInput = document.getElementById('userInput');
                if (userInput.value.trim()) {
                    // Auto-focus on input for potential editing
                    userInput.focus();
                    userInput.setSelectionRange(userInput.value.length, userInput.value.length);
                    
                    // Auto-send after a short delay
                    setTimeout(() => {
                        if (userInput.value.trim() && !isListening) {
                            sendMessage();
                        }
                    }, 1000);
                }
            };

            return recognition;
        }

        // Update microphone button UI
        function updateMicrophoneUI(isActive) {
            const micBtn = document.getElementById('micBtn');
            const micIcon = micBtn.querySelector('i');
            
            if (isActive) {
                micBtn.classList.add('recording');
                micIcon.className = 'fas fa-stop';
                micBtn.title = 'עצור הקלטה';
                micBtn.setAttribute('aria-label', 'עצור הקלטה');
            } else {
                micBtn.classList.remove('recording');
                micIcon.className = 'fas fa-microphone';
                micBtn.title = 'הקלטה קולית';
                micBtn.setAttribute('aria-label', 'הקלטה קולית');
            }
        }

        // Show transcription feedback
        function showTranscriptionFeedback(message) {
            let feedback = document.getElementById('transcriptionFeedback');
            if (!feedback) {
                feedback = document.createElement('div');
                feedback.id = 'transcriptionFeedback';
                feedback.className = 'transcription-feedback';
                document.body.appendChild(feedback);
            }
            
            feedback.textContent = message;
            feedback.classList.add('show');
        }

        // Hide transcription feedback
        function hideTranscriptionFeedback() {
            const feedback = document.getElementById('transcriptionFeedback');
            if (feedback) {
                feedback.classList.remove('show');
            }
        }

        // Voice recording and speech recognition functionality
        function toggleMicrophone() {
            if (!speechRecognition) {
                speechRecognition = initializeSpeechRecognition();
                if (!speechRecognition) {
                    showError('הדפדפן שלך אינו תומך בהקלטה קולית');
                    return;
                }
            }

            if (isListening) {
                // Stop listening
                speechRecognition.stop();
            } else {
                // Start listening
                try {
                    speechRecognition.start();
                } catch (error) {
                    console.error('Error starting speech recognition:', error);
                    showError('שגיאה בהתחלת ההקלטה');
                }
            }
        }

        // Security: Input sanitization function
        function sanitizeInput(input) {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }

        // Security: XSS prevention for markdown
        function safeMarkdownParse(text) {
            // First sanitize the input
            const sanitized = sanitizeInput(text);
            // Then parse with marked (which should be configured to escape HTML)
            return marked.parse(sanitized);
        }

        // Error handling utility
        function showError(message, duration = 5000) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${sanitizeInput(message)}`;
            
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.appendChild(errorDiv);
            scrollToBottom();
            
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, duration);
        }

        // Success handling utility
        function showSuccess(message, duration = 5000) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${sanitizeInput(message)}`;
            
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.appendChild(successDiv);
            scrollToBottom();
            
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.remove();
                }
            }, duration);
        }

        // Enhanced scroll management
        let userScrolledUp = false;
        let lastScrollTop = 0;

        // Check if user has manually scrolled up
        function checkUserScroll() {
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) return;
            
            const currentScrollTop = chatContainer.scrollTop;
            const scrollHeight = chatContainer.scrollHeight;
            const clientHeight = chatContainer.clientHeight;
            
            // User is considered to have scrolled up if they're not at the bottom
            // and the scroll position has changed (not just initial load)
            if (lastScrollTop > 0) {
                userScrolledUp = currentScrollTop + clientHeight < scrollHeight - 10;
            }
            
            lastScrollTop = currentScrollTop;
        }

        // Enhanced scroll to bottom with smart behavior
        function scrollToBottom(force = false) {
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) return;
            
            // Don't auto-scroll if user manually scrolled up (unless forced)
            if (userScrolledUp && !force) {
                return;
            }
            
            // Use requestAnimationFrame to ensure DOM is updated
            requestAnimationFrame(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
                userScrolledUp = false; // Reset flag after auto-scrolling
            });
        }

        // Enhanced scroll to bottom with delay
        function scrollToBottomDelayed(delay = 100, force = false) {
            setTimeout(() => {
                scrollToBottom(force);
            }, delay);
        }

        // Smooth scroll to bottom
        function smoothScrollToBottom(force = false) {
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) return;
            
            // Don't auto-scroll if user manually scrolled up (unless forced)
            if (userScrolledUp && !force) {
                return;
            }
            
            const lastMessage = chatContainer.lastElementChild;
            if (lastMessage) {
                lastMessage.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'end',
                    inline: 'nearest'
                });
                userScrolledUp = false; // Reset flag after auto-scrolling
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            } else if (event.key === 'Tab') {
                event.preventDefault();
                // Navigate between controls
                const controls = ['userInput', 'micBtn', 'sendBtn'];
                const currentIndex = controls.indexOf(document.activeElement.id);
                const nextIndex = (currentIndex + 1) % controls.length;
                document.getElementById(controls[nextIndex]).focus();
            }
        }

        // Theme toggle with proper state management
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.documentElement.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
            
            const themeIcon = document.querySelector('.theme-toggle i');
            themeIcon.className = isDarkMode ? 'fas fa-sun' : 'fas fa-moon';
            
            // Save preference
            localStorage.setItem('darkMode', isDarkMode);
        }

        // Enhanced export chat with PDF formatting
        function exportChat() {
            try {
                const chatContainer = document.getElementById('chatContainer');
                const messages = Array.from(chatContainer.querySelectorAll('.chat-bubble'));
                
                if (messages.length === 0) {
                    showError('אין הודעות לייצוא');
                    return;
                }
                
                // Create PDF content with nice formatting
                const pdfContent = document.createElement('div');
                pdfContent.style.cssText = `
                    direction: rtl;
                    font-family: 'Noto Sans Hebrew', 'Arial', sans-serif;
                    padding: 20px;
                    background: white;
                    color: #333;
                    line-height: 1.6;
                `;
                
                // Header
                const header = document.createElement('div');
                header.style.cssText = `
                    text-align: center;
                    margin-bottom: 30px;
                    padding-bottom: 20px;
                    border-bottom: 2px solid #6366f1;
                `;
                header.innerHTML = `
                    <h1 style="color: #6366f1; margin: 0 0 10px 0; font-size: 24px;">שיחת בינת קוד המקור</h1>
                    <p style="color: #666; margin: 0; font-size: 14px;">משתמש: ${USER_NAME}</p>
                    <p style="color: #666; margin: 5px 0 0 0; font-size: 14px;">תאריך: ${new Date().toLocaleDateString('he-IL')}</p>
                `;
                pdfContent.appendChild(header);
                
                // Messages container
                const messagesContainer = document.createElement('div');
                messagesContainer.style.cssText = `
                    max-width: 100%;
                `;
                
                messages.forEach((msg, index) => {
                    const isUser = msg.classList.contains('user');
                    const content = msg.querySelector('.message-content').textContent;
                    const time = msg.querySelector('.message-time').textContent;
                    const sender = isUser ? USER_NAME : 'בינת קוד המקור';
                    
                    const messageDiv = document.createElement('div');
                    messageDiv.style.cssText = `
                        margin-bottom: 20px;
                        padding: 15px;
                        border-radius: 10px;
                        position: relative;
                        ${isUser ? 
                            'background: linear-gradient(135deg, #0b2e6b, #0a2a5f); color: white; margin-right: 20px;' : 
                            'background: #f8fafc; border: 1px solid #e2e8f0; margin-left: 20px;'
                        }
                    `;
                    
                    // Sender and time
                    const senderDiv = document.createElement('div');
                    senderDiv.style.cssText = `
                        font-weight: bold;
                        font-size: 12px;
                        margin-bottom: 8px;
                        opacity: 0.8;
                    `;
                    senderDiv.textContent = `${sender} • ${time}`;
                    messageDiv.appendChild(senderDiv);
                    
                    // Message content
                    const contentDiv = document.createElement('div');
                    contentDiv.style.cssText = `
                        font-size: 14px;
                        white-space: pre-wrap;
                        word-wrap: break-word;
                    `;
                    contentDiv.textContent = content;
                    messageDiv.appendChild(contentDiv);
                    
                    messagesContainer.appendChild(messageDiv);
                });
                
                pdfContent.appendChild(messagesContainer);
                
                // Footer
                const footer = document.createElement('div');
                footer.style.cssText = `
                    text-align: center;
                    margin-top: 30px;
                    padding-top: 20px;
                    border-top: 1px solid #e2e8f0;
                    color: #666;
                    font-size: 12px;
                `;
                footer.innerHTML = `
                    <p style="margin: 0;">© 2024 PDN Center - Personal Development Navigator</p>
                    <p style="margin: 5px 0 0 0;">בינת קוד המקור - מערכת ניהול נתוני אבחון פדן</p>
                `;
                pdfContent.appendChild(footer);
                
                // PDF options
                const opt = {
                    margin: [0.5, 0.5, 0.5, 0.5],
                    filename: `chat-export-${USER_NAME}-${new Date().toISOString().split('T')[0]}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        letterRendering: true,
                        allowTaint: true,
                        foreignObjectRendering: false
                    },
                    jsPDF: { 
                        unit: 'in', 
                        format: 'a4', 
                        orientation: 'portrait'
                    }
                };
                
                // Generate and download PDF
                html2pdf().set(opt).from(pdfContent).save().then(() => {
                    showSuccess('השיחה יוצאה בהצלחה!');
                }).catch((error) => {
                    console.error('PDF generation error:', error);
                    showError('שגיאה בייצוא ה-PDF');
                });
                
            } catch (error) {
                console.error('Export error:', error);
                showError('שגיאה בייצוא השיחה');
            }
        }

        // Enhanced send message function with queue and error handling
        async function sendMessage() {
            const input = document.getElementById("userInput");
            const sendBtn = document.getElementById("sendBtn");
            const message = input.value.trim();

            if (message === "" || isProcessing) return;

            // Check if user typed ""סיים שיחה" manually
            if (message.toLowerCase().includes("סיים שיחה") || 
                message.toLowerCase().includes("סיים") && message.toLowerCase().includes("שיחה")) {
                handleThankYouClick();
                return;
            }

            // Add to queue
            messageQueue.push(message);
            input.value = "";
            
            // Process queue
            if (!isProcessing) {
                processMessageQueue();
            }
        }

        async function processMessageQueue() {
            if (messageQueue.length === 0) return;
            
            isProcessing = true;
            const message = messageQueue.shift();
            
            const sendBtn = document.getElementById("sendBtn");
            const chatContainer = document.getElementById("chatContainer");

            // Show loading state
            sendBtn.innerHTML = '<span class="loading-spinner"></span>';
            sendBtn.disabled = true;

            // Create user message bubble
            const userBubble = document.createElement("div");
            userBubble.className = "chat-bubble user animated";
            userBubble.innerHTML = `
                <div class="message-header">${USER_NAME}:</div>
                <div class="message-content">${safeMarkdownParse(message)}</div>
                <div class="message-time">${getCurrentTime()}</div>
            `;

            chatContainer.appendChild(userBubble);
            scrollToBottomDelayed(50, true); // Force scroll for new user message

            // Show typing indicator
            const typing = document.createElement("div");
            typing.className = "typing-indicator";
            typing.innerHTML = `
                בינת מקוד המקור מקליד/ה
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            `;
            chatContainer.appendChild(typing);
            scrollToBottomDelayed(50, true); // Force scroll for typing indicator

            try {
                const res = await fetch("/pdn-chat-ai/chat", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-Requested-With": "XMLHttpRequest"
                    },
                    body: JSON.stringify({
                        message: sanitizeInput(message),
                        user_name: USER_NAME,
                        user_id: USER_ID
                    })
                });

                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }

                const data = await res.json();
                typing.remove();

                // Create bot message bubble
                const botBubble = document.createElement("div");
                botBubble.className = "chat-bubble bot animated";
                botBubble.innerHTML = `
                    <div class="message-header">בינת קוד המקור:</div>
                    <div class="message-content">${safeMarkdownParse(data.message || data.response || 'מצטער, אירעה שגיאה. אנא נסה שוב.')}</div>
                    <div class="message-time">${getCurrentTime()}</div>
                `;

                chatContainer.appendChild(botBubble);
                scrollToBottomDelayed(100, true); // Force scroll for bot message

                // Add quick reply buttons for bot messages
                addQuickReplies(botBubble);
                scrollToBottomDelayed(200, true); // Force scroll after quick replies

            } catch (error) {
                console.error('Error sending message:', error);
                typing.remove();
                showError('שגיאה בשליחת ההודעה לשרת');
            } finally {
                // Restore button state
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> שלח';
                sendBtn.disabled = false;
                isProcessing = false;
                
                // Process next message in queue
                if (messageQueue.length > 0) {
                    setTimeout(processMessageQueue, 100);
                }
            }
        }

        // Add quick reply buttons
        function addQuickReplies(botBubble) {
            const quickReplies = [
                "תוכל/י להסביר יותר על הקוד שלי?",
                "איך אני יכול/ה להשתמש בזה בחיי היומיום?",
                "מה השלב הבא במסע שלי?",
                "סיים שיחה"
            ];

            const quickRepliesDiv = document.createElement("div");
            quickRepliesDiv.className = "quick-replies";
            
            quickReplies.forEach(reply => {
                const button = document.createElement("button");
                button.className = "quick-reply-btn";
                button.textContent = reply;
                button.onclick = () => {
                    // Special handling for "תודה על השיחה" - redirect to login
                    if (reply === "תודה על השיחה") {
                        handleThankYouClick();
                    } else {
                        document.getElementById("userInput").value = reply;
                        sendMessage();
                    }
                };
                quickRepliesDiv.appendChild(button);
            });

            botBubble.appendChild(quickRepliesDiv);
        }

        // Handle "תודה על השיחה" click - redirect to login page
        function handleThankYouClick() {
            // Show custom confirmation modal
            showConfirmationModal();
        }

        // Custom confirmation modal functions
        function showConfirmationModal() {
            const modal = document.getElementById('confirmationModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            
            // Focus on the first button for accessibility
            setTimeout(() => {
                modal.querySelector('.confirmation-btn.cancel').focus();
            }, 100);
        }

        function hideConfirmationModal() {
            const modal = document.getElementById('confirmationModal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
        }

        function confirmLogout() {
            hideConfirmationModal();
            
            // Clear session storage
            sessionStorage.removeItem('username');
            
            // Clear any stored chat data
            localStorage.removeItem('binat_chat_history');
            
            // Clear server-side chat history
            clearServerChatHistory();
            
            // Show goodbye message before redirecting
            const chatContainer = document.getElementById("chatContainer");
            const goodbyeBubble = document.createElement("div");
            goodbyeBubble.className = "chat-bubble bot animated";
            goodbyeBubble.innerHTML = `
                <div class="message-header">בינת קוד המקור:</div>
                <div class="message-content">
                    🌿 תודה לך על השיחה היפה!<br>
                    בינת קוד המקור תמיד כאן בשבילך.<br>
                    עד הפעם הבאה... 💜
                </div>
                <div class="message-time">${getCurrentTime()}</div>
            `;
            
            chatContainer.appendChild(goodbyeBubble);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Redirect after a short delay to show the goodbye message
            setTimeout(() => {
                window.location.href = '/pdn-chat-ai/';
            }, 2000);
        }

        // Function to clear server-side chat history
        async function clearServerChatHistory() {
            try {
                const user_id = '{{ user_id }}' || 'anonymous';
                
                const response = await fetch('/pdn-chat-ai/clear_history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: user_id
                    })
                });
                
                if (response.ok) {
                    console.log('Chat history cleared successfully');
                } else {
                    console.warn('Failed to clear chat history on server');
                }
            } catch (error) {
                console.error('Error clearing chat history:', error);
                // Don't show error to user, just log it
            }
        }

        // Handle escape key to close modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                hideConfirmationModal();
            }
        });

        // Handle click outside modal to close
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('confirmationModal');
            if (e.target === modal) {
                hideConfirmationModal();
            }
        });

        // Initialize chat with proper error handling
        document.addEventListener("DOMContentLoaded", function () {
            try {
                // Load theme preference
                const savedTheme = localStorage.getItem('darkMode');
                if (savedTheme === 'true') {
                    isDarkMode = true;
                    document.documentElement.setAttribute('data-theme', 'dark');
                    const themeIcon = document.querySelector('.theme-toggle i');
                    themeIcon.className = 'fas fa-sun';
                }

                // Set up scroll tracking
                const chatContainer = document.getElementById('chatContainer');
                if (chatContainer) {
                    chatContainer.addEventListener('scroll', checkUserScroll);
                }

                // Add welcome message
                const initialBot = document.createElement("div");
                initialBot.className = "chat-bubble bot animated";
                
                const rawMessage = `🌿 שלום ${USER_NAME},\nבינת מקוד המקור ממתינה לך כאן, בקצב שלך.\n\nאם יש שאלה שלא עוזבת, דפוס שחוזר, או תחושה לא פתורה –\nבוא נסתכל עליה יחד.\nבלי למהר. בלי לשפוט. רק להבין מה פועל בך עכשיו.`;
                const formattedMessage = rawMessage.replace(/\n/g, '<br>');

                initialBot.innerHTML = `
                    <div class="message-header ">בינת קוד המקור:</div>
                    <div class="message-content">${formattedMessage}</div>
                    <div class="message-time">${getCurrentTime()}</div>
                `;

                chatContainer.appendChild(initialBot);
                addQuickReplies(initialBot);

                // Focus on input
                document.getElementById("userInput").focus();
                
                // Load chat history
                loadChatHistory();
                
            } catch (error) {
                console.error('Initialization error:', error);
                showError('שגיאה בטעינת הממשק');
            }
        });

        // Load chat history with error handling
        async function loadChatHistory() {
            try {
                const response = await fetch('/pdn-chat-ai/history');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const history = await response.json();
                
                if (history.messages && history.messages.length > 0) {
                    const chatContainer = document.getElementById("chatContainer");
                    
                    history.messages.forEach(msg => {
                        const bubble = document.createElement("div");
                        bubble.className = `chat-bubble ${msg.type} animated`;
                        bubble.innerHTML = `
                            <div class="message-content">${safeMarkdownParse(msg.content)}</div>
                            <div class="message-time">${msg.timestamp}</div>
                        `;
                        chatContainer.appendChild(bubble);
                    });
                    scrollToBottom();
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
                // Don't show error for history loading failure
            }
        }

        // Configure marked for security
        if (typeof marked !== 'undefined') {
            marked.setOptions({
                breaks: true,
                gfm: true,
                sanitize: false, // We handle sanitization manually
                smartLists: true,
                smartypants: true
            });
        }
    </script>

    <!-- Custom Confirmation Modal -->
    <div class="confirmation-modal" id="confirmationModal">
        <div class="confirmation-content">
            <div class="confirmation-icon">
                <i class="fas fa-question"></i>
            </div>
            <h3 class="confirmation-title">סיים שיחה</h3>
            
            <div class="confirmation-buttons">
                <button class="confirmation-btn cancel" onclick="hideConfirmationModal()">
                    <i class="fas fa-times"></i>
                    ביטול
                </button>
                <button class="confirmation-btn confirm" onclick="confirmLogout()">
                    <i class="fas fa-check"></i>
                    אישור
                </button>
            </div>
        </div>
    </div>
</body>
</html> 