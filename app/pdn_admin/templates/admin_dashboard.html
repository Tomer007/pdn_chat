<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8"/>
    <title>PDN Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background: radial-gradient(ellipse at center, #e0e7ff 0%, #c7d2fe 50%, #7c3aed 100%);
            min-height: 100vh;
        }
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .modal-backdrop {
            position: fixed; 
            inset: 0; 
            background: rgba(0, 0, 0, 0.5); 
            display: none;
            align-items: center; 
            justify-content: center; 
            z-index: 50;
            backdrop-filter: blur(4px);
        }
        .table-container {
            max-height: 65vh;
            overflow-y: auto;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }
        .table-container::-webkit-scrollbar {
            width: 6px;
        }
        .table-container::-webkit-scrollbar-track {
            background: #f3f4f6;
            border-radius: 3px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #6366f1;
            border-radius: 3px;
        }
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #4f46e5;
        }
        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }
        .table-header {
            background: linear-gradient(135deg, #b2d1ef 0%, #f1f5f9 100%);
            border-bottom: 2px solid #e2e8f0;
        }
        .table-row:hover {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            transform: scale(1.001);
            transition: all 0.2s ease;
        }
        .action-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 80px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .action-btn:focus-visible {
            outline: 2px solid #6366f1;
            outline-offset: 2px;
        }
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .action-btn:active {
            transform: translateY(0);
        }
        .action-btn.loading {
            pointer-events: none;
            opacity: 0.7;
        }
        .action-btn.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .action-btn.questionnaire {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }
        .action-btn.questionnaire:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
        }
        .action-btn.voice {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .action-btn.voice:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        .action-btn.edit {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }
        .action-btn.edit:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        }
        .action-btn.download {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        .action-btn.download:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
        }
        .action-btn.delete {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        .action-btn.delete:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }
        .action-btn.email {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
            flex-direction: column;
            min-height: 60px;
            padding: 8px 12px;
        }
        .action-btn.email:hover {
            background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.9) transparent transparent transparent;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 9999;
        }
        .tooltip:hover::before,
        .tooltip:hover::after {
            opacity: 1;
        }
        .search-input {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #d1d5db;
            transition: all 0.3s ease;
        }
        .search-input:focus {
            background: white;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        .animate-fade-in {
            animation: fadeIn 0.7s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .highlight-difference {
            background-color: #fef2f2 !important; /* Light red background */
            border-left: 4px solid #ef4444; /* Red left border for emphasis */
        }
        
        /* Table header improvements to prevent text truncation */
        .table-header th {
            min-width: 120px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 12px 8px;
            font-size: 14px;
            font-weight: 600;
        }
        
        /* Specific column widths for better layout */
        .table-header th:nth-child(1) { /* User ID */
            min-width: 100px;
            max-width: 120px;
        }
        .table-header th:nth-child(2) { /* Email */
            min-width: 180px;
            max-width: 220px;
        }
        .table-header th:nth-child(3) { /* Date */
            min-width: 120px;
            max-width: 140px;
        }
        .table-header th:nth-child(4) { /* System Code */
            min-width: 120px;
            max-width: 140px;
        }
        .table-header th:nth-child(5) { /* Voice Analysis */
            min-width: 140px;
            max-width: 160px;
        }
        .table-header th:nth-child(6) { /* Diagnose Code */
            min-width: 140px;
            max-width: 160px;
        }
        .table-header th:nth-child(7) { /* Comments */
            min-width: 150px;
            max-width: 200px;
        }
        .table-header th:nth-child(8) { /* Actions */
            min-width: 100px;
            max-width: 120px;
        }
        
        /* Ensure table cells don't truncate content */
        .table-container td {
            padding: 12px 8px;
            vertical-align: middle;
            word-wrap: break-word;
            max-width: 200px;
        }
        /* Alternative styling - you can choose which one you prefer */
        .highlight-difference td {
            color: #0e0e0d; 
            font-weight: 500;
        }
        
        /* Enhanced notification animations */
        .notification-item {
            animation: notificationSlideIn 0.5s ease-out;
        }
        
        @keyframes notificationSlideIn {
            from {
                opacity: 0;
                transform: translateX(100%) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }
        
        .notification-item.animate-bounce {
            animation: notificationBounce 0.6s ease-in-out;
        }
        
        @keyframes notificationBounce {
            0%, 20%, 53%, 80%, 100% {
                transform: translate3d(0, 0, 0);
            }
            40%, 43% {
                transform: translate3d(0, -8px, 0);
            }
            70% {
                transform: translate3d(0, -4px, 0);
            }
            90% {
                transform: translate3d(0, -2px, 0);
            }
        }
        
        /* Notification glow effect */
        .notification-item {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(255, 255, 255, 0.1);
        }
        
        .notification-item[class*="border-red"] {
            box-shadow: 0 10px 25px rgba(195, 229, 161, 0.2), 0 0 0 1px rgba(239, 68, 68, 0.3);
        }
        
        .notification-item[class*="border-green"] {
            box-shadow: 0 10px 25px rgba(34, 197, 94, 0.2), 0 0 0 1px rgba(34, 197, 94, 0.3);
        }
        
        .notification-item[class*="border-blue"] {
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.2), 0 0 0 1px rgba(59, 130, 246, 0.3);
        }
        
        .notification-item[class*="border-yellow"] {
            box-shadow: 0 10px 25px rgba(234, 179, 8, 0.2), 0 0 0 1px rgba(234, 179, 8, 0.3);
        }
        .download-csv-btn {
            box-shadow: 0 4px 16px 0 rgba(99, 102, 241, 0.10), 0 1.5px 4px 0 rgba(139, 92, 246, 0.10);
            border: 1.5px solid #a5b4fc;
            letter-spacing: 0.02em;
            background: linear-gradient(90deg, #6366f1 0%, #a21caf 60%, #ec4899 100%);
        }
        .download-csv-btn:hover, .download-csv-btn:focus {
            box-shadow: 0 6px 20px 0 rgba(99, 102, 241, 0.18), 0 2px 8px 0 rgba(139, 92, 246, 0.15);
            border-color: #6366f1;
            outline: none;
            background: linear-gradient(90deg, #4f46e5 0%, #7c3aed 60%, #db2777 100%);
        }

    </style>
</head>
<body class="p-6">

<!-- Main Dashboard -->
<div id="dashboard" class="space-y-8">
    <!-- Header -->
    <div class="card p-8 rounded-2xl bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200">
        <div class="flex justify-between items-center">
            <div class="flex items-center space-x-6 space-x-reverse">
                <div class="flex-shrink-0">
                    <img src="static/images/pdn_logo.png"
                         alt="PDN Logo"
                         class="h-20 w-auto object-contain drop-shadow-lg"
                         style="max-width: 250px;">
                </div>
                <div class="border-r border-indigo-300 pr-6">
                    <h1 class="text-4xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                        注专转 砖 
                    </h1>
                    <p class="text-lg text-gray-700 mt-2 font-medium"> 转  驻</p>
                    <div class="flex items-center mt-2 space-x-4 space-x-reverse">
                        <span class="px-3 py-1 bg-indigo-100 text-indigo-800 rounded-full text-sm font-medium">
                            <i class="fas fa-shield-alt mr-1"></i>注专转  转
                        </span>
                    </div>
                </div>
            </div>
            <div class="flex space-x-4 space-x-reverse">
                <button id="refreshBtn"
                        class="btn-success text-white px-6 py-3 rounded-lg font-semibold text-base transition-all duration-300 flex items-center shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                    <i class="fas fa-sync-alt mr-2"></i>
                    专注 转
                </button>
                <button id="logoutBtn"
                        class="btn-danger text-white px-6 py-3 rounded-lg font-semibold text-base transition-all duration-300 flex items-center shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    转转拽
                </button>
            </div>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="card p-8 rounded-2xl">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4 space-x-reverse">
                <label for="searchInput" class="text-lg font-medium text-gray-700 flex items-center">
                    <i class="fas fa-search mr-2"></i>
                    驻砖  驻 :
                </label>
                <input type="text" id="searchInput" placeholder="拽  驻砖..."
                       class="px-4 py-3 search-input rounded-lg transition-all duration-300 w-64">
            </div>
            <div class="flex items-center space-x-4 space-x-reverse">
                <label class="flex items-center space-x-2 space-x-reverse cursor-pointer">
                    <input type="checkbox" id="redUsersFilter"
                           class="w-4 h-4 text-red-600 bg-gray-100 border-gray-300 rounded focus:ring-red-500 focus:ring-2">
                    <span class="text-lg font-medium text-gray-700 flex items-center">
                        <i ></i>
                        爪  专
                    </span>
                </label>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="card p-8 rounded-2xl">
        <div class="mb-6">
            <h3 class="text-xl font-semibold text-gray-800 flex items-center mb-2">
                <i class="fas fa-users mr-2"></i>
                转 
            </h3>
            <div class="flex items-center justify-between">
                <span id="rowCount" class="text-base text-gray-600">住" :</span>
                <button id="downloadCsvBtn"
                        class="download-csv-btn flex items-center px-5 py-2 rounded-xl font-semibold text-white shadow-md transition-all duration-300">
                    <i class="fas fa-download ml-2 text-lg"></i>
                    专 
                </button>
            </div>
        </div>
        <div class="table-container">
            <table class="w-full">
                <thead class="table-header sticky top-0">
                <tr>
                    <th class="px-4 py-4 text-right font-semibold text-gray-700" title=" 注专转"> 注专转</th>
                    <th class="px-4 py-4 text-right font-semibold text-gray-700" title=""></th>
                    <th class="px-4 py-4 text-right font-semibold text-gray-700" title="转专 ">转专</th>
                    <th class="px-4 py-4 text-right font-semibold text-gray-700" title="拽 注专转">拽 注专转</th>                    
                    <th class="px-4 py-4 text-right font-semibold text-gray-700" title="转 拽">转 拽</th>
                    <th class="px-4 py-4 text-right font-semibold text-gray-700" title="拽 ">拽 </th>
                    <th class="px-4 py-4 text-right font-semibold text-gray-700" title="注专转 ">注专转</th>
                    <th class="px-4 py-4 text-right font-semibold text-gray-700" title="注专转 注 拽 驻">注 拽 驻</th>
                    <th class="px-4 py-4 text-right font-semibold text-gray-700" title="驻注转">驻注转</th>
                </tr>
                </thead>
                <tbody id="tableBody">
                <!-- Data will be populated here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Footer -->
    <div class="card p-8 rounded-2xl bg-gradient-to-r from-gray-50 to-slate-50 border border-gray-200">
        <div class="text-center space-y-6">
            <!-- Links and Info -->
            <div class="flex flex-wrap justify-center items-center space-x-8 space-x-reverse text-sm text-gray-600">
                <a href="https://www.pdn.co.il" target="_blank"
                   class="hover:text-indigo-600 transition-colors flex items-center">
                    <i class="fas fa-globe mr-2"></i>
                    转专 专砖
                </a>
                <span class="flex items-center">
                    <i class="fas fa-shield-alt mr-2"></i>
                    注专转 转
                </span>
            </div>

            <!-- Copyright -->
            <div class="border-t border-gray-200 pt-6">
                <p class="text-xs text-gray-500">
                    漏 2024 PDN Center  转 砖专转
                </p>
                <p class="text-xs text-gray-400 mt-2">
                    注专转  转  驻 - 专住 1.0
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Questionnaire Modal -->
<div id="questionnaireModal" class="modal-backdrop">
    <div class="card p-8 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto rounded-2xl">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                <i class="fas fa-clipboard-list mr-2 text-indigo-600"></i>
                转 砖
            </h2>
            <button onclick="closeModal('questionnaireModal')"
                    class="text-gray-500 hover:text-gray-700 text-2xl transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="questionnaireContent" class="space-y-4">
            <!-- Questionnaire data will be populated here -->
        </div>
    </div>
</div>

<!-- Voice Modal -->
<div id="voiceModal" class="modal-backdrop">
    <div class="card p-8 max-w-2xl w-full mx-4 rounded-2xl">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                <i class="fas fa-microphone mr-2 text-indigo-600"></i>
                拽 拽转
            </h2>
            <button onclick="closeModal('voiceModal')"
                    class="text-gray-500 hover:text-gray-700 text-2xl transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="voiceContent" class="space-y-4">
            <!-- Voice player will be populated here -->
        </div>
    </div>
</div>

<!-- Edit Diagnose Modal -->
<div id="editDiagnoseModal" class="modal-backdrop">
    <div class="card p-8 max-w-2xl w-full mx-4 rounded-2xl">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                <i></i>
                注专转 
            </h2>
            <button onclick="closeModal('editDiagnoseModal')"
                    class="text-gray-500 hover:text-gray-700 text-2xl transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="editDiagnoseForm" class="space-y-4">
            <div>
                <label for="diagnosePdnCode" class="block text-sm font-medium text-gray-700 mb-2">
                    <i></i><span>拽 PDN </span>
                </label>
                <input type="text" id="diagnosePdnCode" name="diagnose_pdn_code" required
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-300">
            </div>
            <div>
                <label for="diagnoseComments" class="block text-sm font-medium text-gray-700 mb-2">
                    <i ></i><span>注专转 </span>
                </label>
                <textarea id="diagnoseComments" name="diagnose_comments" rows="4" required
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-300"></textarea>
            </div>
            <div class="flex space-x-4 space-x-reverse">
                <button type="submit"
                        class="flex-1 py-3 px-6 btn-success text-white font-semibold rounded-lg transition-all duration-300 flex items-center justify-center">
                    <i class="fas fa-save mr-2"></i>
                    砖专
                </button>
                <button type="button" onclick="closeModal('editDiagnoseModal')"
                        class="flex-1 py-3 px-6 btn-secondary text-white font-semibold rounded-lg transition-all duration-300 flex items-center justify-center">
                    <i class="fas fa-times mr-2"></i>
                    
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Enhanced Action Modal -->
<div x-data="{ showActionModal: false, modalText: '', loadingBtn: '' }"
     x-show="showActionModal"
     @click.away="showActionModal = false"
     class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50"
     x-transition>
    <div class="bg-white rounded-lg shadow-lg p-6 w-80 text-center animate-fade-in">
        <h2 class="text-lg font-semibold mb-4">驻注 转爪注转</h2>
        <p x-text="modalText" class="text-gray-700 mb-4"></p>
        <div class="flex justify-center mb-4">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
        </div>
        <button @click="showActionModal = false"
                class="mt-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-colors">
            住专
        </button>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner"
     class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 backdrop-blur-sm">
    <div class="card p-8 text-center rounded-2xl">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
        <p class="text-lg text-gray-700">注...</p>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
// Utility: Get user email from modal content (assumes email is present in a data attribute or visible field)
function getDiagnosisUserEmail() {
    // Try to find an element with data-email or fallback to text content
    const emailElem = document.querySelector('#questionnaireContent [data-email]');
    if (emailElem) return emailElem.getAttribute('data-email');
    // Fallback: try to find a visible email in the content
    const match = document.getElementById('questionnaireContent').innerText.match(/[\w.-]+@[\w.-]+/);
    return match ? match[0] : 'user';
}

// Main PDF export function
function downloadDiagnosisAsPDF() {
    const content = document.getElementById('questionnaireContent');
    if (!content) {
        alert(' 爪 转 爪');
        return;
    }
    
    // Create a new container for the complete report
    const reportContainer = document.createElement('div');
    reportContainer.style.cssText = `
        font-family: 'Noto Sans Hebrew', 'Arial', sans-serif !important;
        direction: rtl !important;
        text-align: right !important;
        font-size: 14px !important;
        line-height: 1.6 !important;
        color: #000 !important;
        background: white !important;
        padding: 20px !important;
        width: 100% !important;
        max-width: 800px !important;
        margin: 0 auto !important;
    `;
    reportContainer.setAttribute('dir', 'rtl');
    reportContainer.setAttribute('lang', 'he');
    
    // Clone the questionnaire content
    const questionnaireClone = content.cloneNode(true);
    
    // Remove the user metadata section from the clone
    const metadataSection = questionnaireClone.querySelector('.bg-gradient-to-br.from-blue-50.via-indigo-50.to-purple-50');
    if (metadataSection) {
        metadataSection.remove();
    }
    
    // Find the questionnaire section and add user ID before it
    const questionnaireSection = questionnaireClone.querySelector('.bg-white.p-8.rounded-2xl.border.border-gray-200.shadow-lg.mt-6');
    if (questionnaireSection) {
        // Create user ID section
        const userIdSection = document.createElement('div');
        userIdSection.style.cssText = `
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #d1d5db;
            text-align: center;
            font-family: 'Noto Sans Hebrew', 'Arial', sans-serif !important;
            direction: rtl !important;
        `;
        
        const userId = getUserMetadata('user_id');
        userIdSection.innerHTML = `
            <div style="font-size: 16px; font-weight: bold; color: #374151; margin-bottom: 8px; font-family: 'Noto Sans Hebrew', 'Arial', sans-serif;">
                 注专转
            </div>
            <div style="font-family: monospace; font-size: 18px; font-weight: bold; color: #1e40af; background: white; padding: 8px 16px; border-radius: 8px; display: inline-block; border: 1px solid #d1d5db;">
                ${userId}
            </div>
        `;
        
        // Insert the user ID section before the questionnaire section
        questionnaireSection.parentNode.insertBefore(userIdSection, questionnaireSection);
    }
    
    // Apply RTL and font styles to all elements in the clone
    const allElements = questionnaireClone.querySelectorAll('*');
    allElements.forEach(element => {
        element.style.fontFamily = "'Noto Sans Hebrew', 'Arial', sans-serif";
        element.style.direction = 'rtl';
        element.style.textAlign = 'right';
    });
    
    // Add the modified content to the report container
    reportContainer.appendChild(questionnaireClone);
    
    // Generate filename with user ID and date
    const userId = getUserMetadata('user_id');
    const date = new Date().toLocaleDateString('he-IL', { year: 'numeric', month: '2-digit', day: '2-digit' });
    
    // Create filename: user_id_date.pdf
    const filename = `${userId}_${date}.pdf`;
    
    // PDF options with better Hebrew support
    const opt = {
        margin:       [0.5, 0.5, 0.5, 0.5], // inches (top, left, bottom, right)
        filename:     filename,
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { 
            scale: 2, 
            useCORS: true,
            allowTaint: true,
            backgroundColor: '#ffffff'
        },
        jsPDF:        { 
            unit: 'in', 
            format: 'a4', 
            orientation: 'portrait',
            compress: true
        },
        pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
    };
    
    // Use html2pdf
    html2pdf().set(opt).from(reportContainer).save();
}

// Helper function to get user metadata from the current data
function getUserMetadata(field) {
    // Try to get from the current user data
    const currentUser = getCurrentUserFromModal();
    if (currentUser && currentUser[field]) {
        return currentUser[field];
    }
    
    // Try to get from the metadata in the modal content
    const metadataElement = document.querySelector('#questionnaireContent .font-mono.font-bold.text-blue-600.text-lg');
    if (metadataElement && field === 'user_id') {
        return metadataElement.textContent.trim();
    }
    
    // Try to get from the metadata object in the displayQuestionsWithText function
    const metadataSection = document.querySelector('#questionnaireContent .bg-gradient-to-br.from-blue-50.via-indigo-50.to-purple-50');
    if (metadataSection) {
        const userIdElement = metadataSection.querySelector('.font-mono.font-bold.text-blue-600.text-lg');
        if (userIdElement && field === 'user_id') {
            return userIdElement.textContent.trim();
        }
    }
    
    // Fallback values
    const fallbacks = {
        'user_id': ' ',
        'email': getDiagnosisUserEmail(),
        'date': ' ',
        'pdn_code': ' ',
        'pdn_voice_code': ' ',
        'diagnose_pdn_code': ' ',
        'diagnose_comments': ' 注专转'
    };
    
    return fallbacks[field] || ' ';
}

// Helper function to get current user data from the modal
function getCurrentUserFromModal() {
    const userEmail = getDiagnosisUserEmail();
    if (userEmail && currentData) {
        return currentData.find(user => user.email === userEmail);
    }
    return null;
}

let sessionToken = null;
let currentData = [];
let currentEditEmail = null;

// Function to format timestamp
function formatTimestamp(timestamp) {
    if (!timestamp) return ' ';
    
    try {
        // Handle different timestamp formats
        let cleanTimestamp = timestamp.replace(/_/g, ' ').trim();
        
        // If it's already in a readable format, return as is
        if (cleanTimestamp.includes('-') || cleanTimestamp.includes('/')) {
            return cleanTimestamp;
        }
        
        // Parse timestamp in format "YYYY MM DD HH MM" or "YYYY_MM_DD_HH_MM"
        const parts = cleanTimestamp.split(/[\s_]+/);
        
        if (parts.length >= 5) {
            const [year, month, day, hour, minute] = parts;
            
            // Validate parts
            if (year && month && day && hour && minute) {
                // Format as Hebrew date: DD/MM/YYYY HH:MM
                return `${day}/${month}/${year} ${hour}:${minute}`;
            }
        }
        
        // If parsing fails, return the cleaned timestamp
        return cleanTimestamp;
    } catch (error) {
        console.error('Error formatting timestamp:', error);
        return timestamp.replace(/_/g, ' ');
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Get session token from localStorage
    sessionToken = localStorage.getItem('adminSessionToken');
    
    // If no session token, redirect to login
    if (!sessionToken) {
        window.location.href = '/pdn-admin/';
        return;
    }
    
    setupEventListeners();
    loadMetadata();
    
    // Add global error handler for 401 responses
    window.addEventListener('unhandledrejection', function(event) {
        if (event.reason && event.reason.status === 401) {
            console.log('Global 401 error handler: Session expired, redirecting to login');
            localStorage.removeItem('adminSessionToken');
            window.location.href = '/pdn-admin/';
        }
    });
});

function setupEventListeners() {
    // Search functionality
    document.getElementById('searchInput').addEventListener('input', handleSearch);
    
    // Red users filter
    document.getElementById('redUsersFilter').addEventListener('change', handleFilter);
    
    // Refresh button
    document.getElementById('refreshBtn').addEventListener('click', loadMetadata);
    
    // Logout button
    document.getElementById('logoutBtn').addEventListener('click', handleLogout);
    
    // Edit diagnose form
    document.getElementById('editDiagnoseForm').addEventListener('submit', handleEditDiagnose);
    
    // CSV download button
    document.getElementById('downloadCsvBtn').addEventListener('click', function() {
        downloadCsvFile();
    });
}

async function handleLogout() {
    if (sessionToken) {
        try {
            await fetch(`/pdn-admin/logout?session_token=${sessionToken}`);
        } catch (error) {
            console.error('Logout error:', error);
        }
    }
    sessionToken = null;
    // Clear session token from localStorage
    localStorage.removeItem('adminSessionToken');
    // Redirect to login page
    window.location.href = '/pdn-admin/';
}

async function loadMetadata() {
    showLoading();
    console.log('loadMetadata sessionToken', sessionToken);
    try {
        const response = await fetch('/pdn-admin/metadata/csv?session_token=' + sessionToken);
        if (response.ok) {
            const data = await response.json();
            currentData = data.data;
            renderTable(currentData);
        } else if (response.status === 401) {
            // Session expired or invalid, redirect to login
            console.log('Session expired, redirecting to login');
            localStorage.removeItem('adminSessionToken');
            window.location.href = '/pdn-admin/';
        }else {
            throw new Error('Failed to load metadata');
        }
    } catch (error) {
        console.error('Error loading metadata:', error);
        alert('砖 注转 转');
    } finally {
        hideLoading();
    }
}

function renderTable(data) {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    
    // Update row count
    document.getElementById('rowCount').textContent = `住\" 砖专转: ${data.length}`;
    
    data.forEach(user => {
        const row = document.createElement('tr');
        
        // Check if any of the three codes are different
        const isDifferent = (user.pdn_code !== user.diagnose_pdn_code && 
                           user.diagnose_pdn_code !== "N/A" && 
                           user.diagnose_pdn_code !== "") ||
                           (user.pdn_code !== user.pdn_voice_code && 
                           user.pdn_voice_code !== "N/A" && 
                           user.pdn_voice_code !== "") ||
                           (user.pdn_voice_code !== user.diagnose_pdn_code && 
                           user.diagnose_pdn_code !== "N/A" && 
                           user.diagnose_pdn_code !== "" &&
                           user.pdn_voice_code !== "N/A" && 
                           user.pdn_voice_code !== "");
        
        // Add red background class if codes are different
        if (isDifferent) {
            row.classList.add('highlight-difference');
        }
        
        row.innerHTML = `
            <td class="px-4 py-4">
                <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-xs font-medium font-mono">${user.user_id || 'N/A'}</span>
            </td>
            <td class="px-4 py-4 font-medium text-gray-900">${user.email}</td>
            <td class="px-4 py-4 text-gray-700">${user.date}</td>
            <td class="px-4 py-4">
                <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium"> ${user.pdn_code}</span>
            </td>
            <td class="px-4 py-4">
                <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-medium"> ${user.pdn_voice_code || 'N/A'}</span>
            </td>
            <td class="px-4 py-4">
                <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium"> ${user.diagnose_pdn_code || 'N/A'}</span>
            </td>
            <td class="px-4 py-4 text-gray-700 max-w-xs truncate" title="${user.diagnose_comments || ''}">${user.diagnose_comments || ''}</td>
            <td class="px-4 py-4 text-gray-700 max-w-xs truncate" title="${user.pdn_update_comments || ''}">${user.pdn_update_comments || ''}</td>
            <td class="px-4 py-4">
                <div class="relative" x-data="{ open: false, loadingBtn: '', modalText: '', showModal: false }">
                    <button @click="open = !open" 
                            class="action-btn bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-all duration-300 flex items-center">
                        <i class="fas fa-cogs mr-2"></i>
                        驻注转
                        <i class="fas fa-chevron-down mr-2 transition-transform" :class="{ 'rotate-180': open }"></i>
                    </button>
                    
                    <div x-show="open" 
                         @click.away="open = false"
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="transform opacity-0 scale-95"
                         x-transition:enter-end="transform opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-75"
                         x-transition:leave-start="transform opacity-100 scale-100"
                         x-transition:leave-end="transform opacity-0 scale-95"
                         class="absolute left-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
                        
                        <div class="py-1">
                            <button @click="loadingBtn = 'questionnaire'; modalText = '注 转 砖...'; showModal = true; viewQuestionnaire('${user.email}'); open = false" 
                                    class="w-full text-right px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center"
                                    :disabled="loadingBtn === 'questionnaire'">
                                <i class="fas fa-clipboard-list ml-2"></i>
                                爪驻 砖
                            </button>
                            
                            <button @click="loadingBtn = 'voice'; modalText = '注 拽 拽转...'; showModal = true; playVoice('${user.email}'); open = false" 
                                    class="w-full text-right px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center"
                                    :disabled="loadingBtn === 'voice'">
                                <i class="fas fa-microphone ml-2"></i>
                                 拽
                            </button>
                            
                            <button @click="loadingBtn = 'edit'; modalText = '注专 ...'; showModal = true; editDiagnose('${user.email}'); open = false" 
                                    class="w-full text-right px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center"
                                    :disabled="loadingBtn === 'edit'">
                                <i class="fas fa-edit ml-2"></i>
                                注专 
                            </button>
                            
                            <button @click="loadingBtn = 'email'; modalText = '砖 ...'; showModal = true; sendEmail('${user.email}'); open = false" 
                                    class="w-full text-right px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center"
                                    :disabled="loadingBtn === 'email'">
                                <i class="fas fa-envelope ml-2"></i>
                                砖 
                            </button>
                            
                            <button @click="loadingBtn = 'recalculate'; modalText = '砖 砖 拽 驻...'; showModal = true; recalculatePdnCode('${user.email}'); open = false" 
                                    class="w-full text-right px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center"
                                    :disabled="loadingBtn === 'recalculate'">
                                <i class="fas fa-calculator ml-2"></i>
                                砖 砖 拽 驻
                            </button>
                        </div>
                    </div>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Initialize tooltips after rendering
    initializeTooltips();
}

function initializeTooltips() {
    // Remove any existing tooltip elements
    const existingTooltips = document.querySelectorAll('.custom-tooltip');
    existingTooltips.forEach(tooltip => tooltip.remove());
    
    // Add event listeners to all tooltip elements
    const tooltipElements = document.querySelectorAll('[data-tooltip]');
    tooltipElements.forEach(element => {
        element.addEventListener('mouseenter', showCustomTooltip);
        element.addEventListener('mouseleave', hideCustomTooltip);
    });
}

function showCustomTooltip(event) {
    const element = event.target;
    const tooltipText = element.getAttribute('data-tooltip');
    
    if (!tooltipText) return;
    
    // Create tooltip element
    const tooltip = document.createElement('div');
    tooltip.className = 'custom-tooltip';
    tooltip.textContent = tooltipText;
    tooltip.style.cssText = `
        position: absolute;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 12px;
        white-space: nowrap;
        z-index: 99999;
        pointer-events: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        opacity: 0;
        transition: opacity 0.3s ease;
    `;
    
    document.body.appendChild(tooltip);
    
    // Position tooltip
    const rect = element.getBoundingClientRect();
    tooltip.style.left = rect.left + (rect.width / 2) - (tooltip.offsetWidth / 2) + 'px';
    tooltip.style.top = rect.top - tooltip.offsetHeight - 8 + 'px';
    
    // Show tooltip
    setTimeout(() => {
        tooltip.style.opacity = '1';
    }, 10);
}

function hideCustomTooltip(event) {
    const tooltips = document.querySelectorAll('.custom-tooltip');
    tooltips.forEach(tooltip => {
        tooltip.style.opacity = '0';
        setTimeout(() => {
            if (tooltip.parentElement) {
                tooltip.remove();
            }
        }, 300);
    });
}

function handleSearch(e) {
    applyFilters();
}

function handleFilter(e) {
    applyFilters();
}

function applyFilters() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const showRedUsersOnly = document.getElementById('redUsersFilter').checked;
    
    let filteredData = currentData.filter(user => {
        // Email search filter
        const matchesSearch = user.email.toLowerCase().includes(searchTerm);
        
        // Red users filter - check if any of the three codes are different
        const isRedUser = (user.pdn_code !== user.diagnose_pdn_code && 
                         user.diagnose_pdn_code !== "N/A" && 
                         user.diagnose_pdn_code !== "") ||
                         (user.pdn_code !== user.pdn_voice_code && 
                         user.pdn_voice_code !== "N/A" && 
                         user.pdn_voice_code !== "") ||
                         (user.pdn_voice_code !== user.diagnose_pdn_code && 
                         user.diagnose_pdn_code !== "N/A" && 
                         user.diagnose_pdn_code !== "" &&
                         user.pdn_voice_code !== "N/A" && 
                         user.pdn_voice_code !== "");
        
        if (showRedUsersOnly) {
            return matchesSearch && isRedUser;
        } else {
            return matchesSearch;
        }
    });
    
    renderTable(filteredData);
}

async function viewQuestionnaire(email) {
    if (!sessionToken) {
        window.location.href = '/pdn-admin/';
        return;
    }
    
    try {
        const response = await fetch(`/pdn-admin/user/questionnaire/${email}?session_token=${sessionToken}`);
        if (response.ok) {
            const data = await response.json();
            displayQuestionnaire(data);
            // Reset loading state for this specific row
            resetRowLoadingState(email, 'questionnaire');
        } else if (response.status === 401) {
            // Session expired or invalid, redirect to login
            console.log('Session expired, redirecting to login');
            localStorage.removeItem('adminSessionToken');
            window.location.href = '/pdn-admin/';
        } else {
            throw new Error('Failed to load questionnaire');
        }
    } catch (error) {
        console.error('Error loading questionnaire:', error);
        showNotification('砖 注转 砖', 'error');
        // Reset loading state for this specific row
        resetRowLoadingState(email, 'questionnaire');
    }
}

function displayQuestionnaire(data) {

    const content = document.getElementById('questionnaireContent');
    
    // Extract metadata and questions
    const metadata = data.metadata || {};
    const questions = {};
    const questionsData = data.questions_data || {};
    
    // Separate questions from metadata
    Object.keys(data).forEach(key => {
        if (key !== 'metadata' && key !== 'questions_data' && !isNaN(key)) {
            questions[key] = data[key];
        }
    });
 
    displayQuestionsWithText(questions, metadata, questionsData);
}

function displayQuestionsWithText(questions, metadata, questionsData) {
    const content = document.getElementById('questionnaireContent');
    
    content.innerHTML = `
        <div class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 p-8 rounded-2xl border border-blue-200 shadow-lg">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold text-gray-800">
                    驻专 砖转砖
                </h3>
                <button id="downloadPdfBtn"
                    class="flex items-center gap-3 px-6 py-3 bg-gradient-to-r from-yellow-400 to-yellow-600 text-white font-bold rounded-xl shadow-lg hover:from-yellow-500 hover:to-yellow-700 transition-all duration-300 text-base transform hover:scale-105"
                    onclick="downloadDiagnosisAsPDF()">
                    <i class="fas fa-file-arrow-down text-lg"></i>
                    专 
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                <!-- Personal Information Section -->
                <div class="space-y-4">
                   <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow">
                        <div class="text-sm text-gray-500 mb-1">砖 驻专</div>
                        <div class="font-bold text-gray-900 text-lg">${ metadata["First Name"] || ' '}</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow">
                        <div class="text-sm text-gray-500 mb-1">砖 砖驻</div>
                        <div class="font-bold text-gray-900 text-lg">${metadata["Last Name"] || ' '}</div>
                    </div>
                </div>

                <!-- System Information Section -->
                <div class="space-y-4">
                     <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow">
                        <div class="text-sm text-gray-500 mb-1"> 注专转</div>
                        <div  class="font-bold text-gray-900 text-lg break-all">${metadata["User ID"] || ' '}</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow">
                        <div class="text-sm text-gray-500 mb-1"></div>
                        <div class="font-bold text-gray-900 text-lg break-all">${metadata["Email"] || ' '}</div>
                    </div>
                </div>

                <!-- Diagnosis Information Section -->
                <div class="space-y-4">
                    <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow">
                        <div class="text-sm text-gray-500 mb-1">拽 驻</div>
                        <div >${metadata["PDN Code"] || ' '}</div>
                    </div>
                     <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow">
                        <div class="text-sm text-gray-500 mb-1">转专 </div>
                        <div class="font-bold text-gray-900 text-lg">${metadata["Date"] || ' '}</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="bg-white p-8 rounded-2xl border border-gray-200 shadow-lg mt-6">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">
                转砖转  (${Object.keys(questions).length} 砖转)
            </h3>
            <div class="space-y-6">
                ${Object.entries(questions).map(([questionNumber, questionData]) => {
                    // Handle different question types
                    let answerDisplay = '';
                    let codeDisplay = '';
                    let questionText = `砖 ${questionNumber}`;
                    
                    // Get question text from questions data
                    if (questionsData) {
                        // Search for question in all phases
                        for (const phaseKey in questionsData.phases) {
                            const phase = questionsData.phases[phaseKey];
                            if (phase.questions && phase.questions[questionNumber]) {
                                questionText = phase.questions[questionNumber].text;
                                console.log(questionText);
                                break;
                            }
                        }
                    }
                    
                    // If question text is not found in questions data, try to get it from the saved answer data
                    if (questionText === `砖 ${questionNumber}` && questionData.question_text) {
                        questionText = questionData.question_text;
                    }
                    
                    if (questionData.ranking) {
                        // For ranking questions, show the ranking data
                        const rankingEntries = Object.entries(questionData.ranking);
                        const sortedRanking = rankingEntries.sort((a, b) => a[1] - b[1]);
                        answerDisplay = sortedRanking.map(([key, value]) => `${key}: ${value}`).join(', ');
                        codeDisplay = '专';
                    } else if (questionData.selected_option_code) {
                        // For questions with selected_option_code
                        answerDisplay = questionData.selected_option_code;
                        codeDisplay = questionText;
                    } else if (questionData.answer && questionData.code) {
                        // For regular questions with answer and code
                        answerDisplay = questionData.answer;
                        codeDisplay = questionText; // Use the actual question text instead of the code
                    } else {
                        // Fallback for any other structure
                        answerDisplay = ' ';
                        codeDisplay = ' ';
                    }
                    
                    // Get question options if available
                    let optionsDisplay = '';
                    if (questionData.question_options && questionData.question_options.length > 0) {
                        optionsDisplay = `
                            <div class="mt-3 p-3 bg-gray-50 rounded-lg">
                                <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center">
                                    <i"></i>驻砖专转 :
                                </h4>
                                <div class="space-y-2">
                                    ${questionData.question_options.map(option => {
                                        const isSelected = questionData.selected_option_code === option.code;
                                        return `
                                            <div class="flex items-center space-x-3 space-x-reverse ${isSelected ? 'bg-green-50 border border-green-200' : 'bg-white border border-gray-200'} rounded-lg p-2">
                                                <span class="px-2 py-1 bg-${isSelected ? 'green' : 'gray'}-100 text-${isSelected ? 'green' : 'gray'}-800 rounded text-xs font-medium flex-shrink-0">
                                                    ${option.code}
                                                </span>
                                                <span class="text-sm text-gray-700 flex-1">${option.text}</span>
                                                ${isSelected ? '<i class="fas fa-check text-green-600"></i>' : ''}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    return `
                        <div class="border-b border-gray-100 pb-4 last:border-b-0">
                            <div class="flex items-start justify-between mb-2">
                                <p class="font-medium text-gray-800 flex-1">${questionText}</p>
                                <span  class="px-2 py-1 bg-indigo-100 text-indigo-800 rounded text-xs font-medium ml-2 flex-shrink-0">
                                    砖 ${questionNumber}
                                </span>
                            </div>
                            <div class="flex items-center space-x-4 space-x-reverse mb-2">
                                <p class="text-gray-600 bg-gray-50 px-3 py-2 rounded-lg inline-block">
                                    <i class="fas fa-check mr-2 text-green-600"></i>转砖: ${answerDisplay}
                                </p>
                            </div>
                            ${optionsDisplay}
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `;
    
    document.getElementById('questionnaireModal').style.display = 'flex';
}

async function playVoice(email) {
    if (!sessionToken) {
        window.location.href = '/pdn-admin/';
        return;
    }
    
    try {
        console.log('Fetching voice for email:', email); // Debug log
        
        const response = await fetch(`/pdn-admin/user/voice/${email}?session_token=${sessionToken}`);
        console.log('Response status:', response.status); // Debug log
        
        if (response.ok) {
            const data = await response.json();
            console.log('Voice data received:', data); // Debug log
            displayVoice(data);
            // Reset loading state for this specific row
            resetRowLoadingState(email, 'voice');
        } else if (response.status === 401) {
            // Session expired or invalid, redirect to login
            console.log('Session expired, redirecting to login');
            localStorage.removeItem('adminSessionToken');
            window.location.href = '/pdn-admin/';
        } else {
            const errorText = await response.text();
            console.error('Server error:', errorText); // Debug log
            throw new Error(`Failed to load voice: ${response.status} ${errorText}`);
        }
    } catch (error) {
        console.error('Error loading voice:', error);
        showNotification('砖 注转 拽', 'error');
        // Reset loading state for this specific row
        resetRowLoadingState(email, 'voice');
    }
}

function displayVoice(data) {
    const content = document.getElementById('voiceContent');
    
    // Check if we have the required data
    if (!data || !data.voice_recordings || Object.keys(data.voice_recordings).length === 0) {
        content.innerHTML = `
            <div class="bg-red-50 p-6 rounded-xl border border-red-200">
                <h3 class="text-lg font-semibold mb-4 text-red-800 flex items-center">
                    <i class="fas fa-exclamation-triangle mr-2"></i>砖
                </h3>
                <p class="text-red-700"> 爪 拽抓 拽 砖转砖 </p>
            </div>
        `;
        document.getElementById('voiceModal').style.display = 'flex';
        return;
    }
    
    // Build HTML for multiple recordings
    let recordingsHtml = '';
    const recordings = data.voice_recordings;
    
    // Helper function to create audio URL
    function createAudioUrl(filePath) {
        // Remove 'saved_results/' prefix if it exists
        let processedPath = filePath;
        if (processedPath.startsWith('saved_results/')) {
            processedPath = processedPath.substring('saved_results/'.length);
        }
        return `/pdn-admin/audio/${encodeURIComponent(processedPath)}?session_token=${sessionToken}`;
    }
    
    // Add question1 recording if exists
    if (recordings.question1) {
        const audioUrl = createAudioUrl(recordings.question1.path);
        recordingsHtml += `
            <div class="bg-white p-6 rounded-xl border border-gray-200 mb-4">
                <h4 class="text-lg font-semibold mb-4 text-gray-800 flex items-center">
                    <i class="fas fa-microphone mr-2 text-indigo-600"></i>砖 1 -  转
                </h4>
                <audio controls class="w-full" preload="metadata">
                    <source src="${audioUrl}" type="audio/wav">
                    <source src="${audioUrl}" type="audio/mp3">
                    <source src="${audioUrl}" type="audio/mpeg">
                    驻驻 砖  转 转 .
                </audio>
            </div>
        `;
    }
    
    // Add question2 recording if exists
    if (recordings.question2) {
        const audioUrl = createAudioUrl(recordings.question2.path);
        recordingsHtml += `
            <div class="bg-white p-6 rounded-xl border border-gray-200 mb-4">
                <h4 class="text-lg font-semibold mb-4 text-gray-800 flex items-center">
                    <i class="fas fa-microphone mr-2 text-purple-600"></i>砖 2 - 转专 砖注转
                </h4>
                <audio controls class="w-full" preload="metadata">
                    <source src="${audioUrl}" type="audio/wav">
                    <source src="${audioUrl}" type="audio/mp3">
                    <source src="${audioUrl}" type="audio/mpeg">
                    驻驻 砖  转 转 .
                </audio>
            </div>
        `;
    }
    
    // Add legacy recording if exists
    if (recordings.legacy) {
        const audioUrl = createAudioUrl(recordings.legacy.path);
        recordingsHtml += `
            <div class="bg-white p-6 rounded-xl border border-gray-200 mb-4">
                <h4 class="text-lg font-semibold mb-4 text-gray-800 flex items-center">
                    <i class="fas fa-microphone mr-2 text-green-600"></i>拽 拽转
                </h4>
                <audio controls class="w-full" preload="metadata">
                    <source src="${audioUrl}" type="audio/wav">
                    <source src="${audioUrl}" type="audio/mp3">
                    <source src="${audioUrl}" type="audio/mpeg">
                    驻驻 砖  转 转 .
                </audio>
            </div>
        `;
    }
    
    content.innerHTML = `
        <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-6 rounded-xl border border-green-200 mb-6">
            <h3 class="text-lg font-semibold mb-4 text-gray-800 flex items-center">
                <i class="fas fa-info-circle mr-2 text-green-600"></i>驻专 拽
            </h3>
            <div class="grid grid-cols-2 gap-4">
                <div><strong>:</strong> ${data.email || ' '}</div>
                <div><strong>住驻专 拽转:</strong> <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-sm">${Object.keys(recordings).length}</span></div>
            </div>
        </div>
        ${recordingsHtml}
    `;
    
    document.getElementById('voiceModal').style.display = 'flex';
    
    // Add event listeners to all audio elements for debugging
    const audioElements = content.querySelectorAll('audio');
    audioElements.forEach((audioElement, index) => {
        audioElement.addEventListener('loadstart', () => console.log(`Audio ${index + 1} loading started`));
        audioElement.addEventListener('canplay', () => console.log(`Audio ${index + 1} can play`));
        audioElement.addEventListener('error', (e) => {
            console.error(`Audio ${index + 1} error:`, e);
            console.error(`Audio ${index + 1} error details:`, audioElement.error);
        });
        audioElement.addEventListener('loadeddata', () => console.log(`Audio ${index + 1} data loaded`));
    });
}

function editDiagnose(email) {
    currentEditEmail = email;
    const user = currentData.find(u => u.email === email);
    
    if (user) {
        document.getElementById('diagnosePdnCode').value = user.diagnose_pdn_code;
        document.getElementById('diagnoseComments').value = user.diagnose_comments;
        document.getElementById('editDiagnoseModal').style.display = 'flex';
        // Reset loading state for this specific row
        resetRowLoadingState(email, 'edit');
    }
}

async function handleEditDiagnose(e) {
    e.preventDefault();
    if (!sessionToken || !currentEditEmail) {
        if (!sessionToken) {
            window.location.href = '/pdn-admin/';
        }
        return;
    }
    
    showLoading();
    try {
        const formData = {
            diagnose_pdn_code: document.getElementById('diagnosePdnCode').value,
            diagnose_comments: document.getElementById('diagnoseComments').value
        };
        
        const response = await fetch(`/pdn-admin/user/diagnose/${currentEditEmail}?session_token=${sessionToken}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            const data = await response.json();
            // Update local data
            const userIndex = currentData.findIndex(u => u.email === currentEditEmail);
            if (userIndex !== -1) {
                currentData[userIndex] = data.user;
                renderTable(currentData);
            }
            closeModal('editDiagnoseModal');
        } else if (response.status === 401) {
            // Session expired or invalid, redirect to login
            console.log('Session expired, redirecting to login');
            localStorage.removeItem('adminSessionToken');
            window.location.href = '/pdn-admin/';
        } else {
            throw new Error('Failed to update diagnose');
        }
    } catch (error) {
        console.error('Error updating diagnose:', error);
        alert('砖 注 ');
    } finally {
        hideLoading();
    }
}

async function sendEmail(email) {
    if (!sessionToken) {
        window.location.href = '/pdn-admin/';
        return;
    }
    
    // Find user data
    const user = currentData.find(u => u.email === email);
    if (!user) {
        showNotification('砖转砖  爪', 'error');
        resetRowLoadingState(email, 'email');
        return;
    }
    
    // Check if PDN code equals diagnose code (拽 )
    const codesMatch = user.pdn_code === user.diagnose_pdn_code && 
                      user.diagnose_pdn_code !== "N/A" && 
                      user.diagnose_pdn_code !== "";
    
    if (!codesMatch) {
        showNotification(' 转 砖  - 拽 驻  转 拽 ', 'error');
        resetRowLoadingState(email, 'email');
        return;
    }
    
    // Prompt for admin password
    const password = prompt(' 住住转  砖转 :');
    if (!password) {
        resetRowLoadingState(email, 'email');
        return;
    }
    
    if (password !== 'admin') {
        showNotification('住住 砖', 'error');
        resetRowLoadingState(email, 'email');
        return;
    }
    
    try {
        const response = await fetch(`/pdn-admin/user/send_email/${email}?session_token=${sessionToken}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ password: password })
        });
        
        if (response.ok) {
            const data = await response.json();
            showNotification(` 砖 爪 -${email}`, 'success');
            // Reset loading state for this specific row
            resetRowLoadingState(email, 'email');
        } else if (response.status === 401) {
            // Session expired or invalid, redirect to login
            console.log('Session expired, redirecting to login');
            localStorage.removeItem('adminSessionToken');
            window.location.href = '/pdn-admin/';
        } else {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'Failed to send email');
        }
    } catch (error) {
        console.error('Error sending email:', error);
        showNotification(`砖 砖转 : ${error.message}`, 'error');
        // Reset loading state for this specific row
        resetRowLoadingState(email, 'email');
    }
}

async function recalculatePdnCode(email) {
    if (!sessionToken) {
        window.location.href = '/pdn-admin/';
        return;
    }
    
    // Find user data
    const user = currentData.find(u => u.email === email);
    if (!user) {
        showNotification('砖转砖  爪', 'error');
        resetRowLoadingState(email, 'recalculate');
        return;
    }
    
    // Prompt for admin password
    const password = prompt(' 住住转  砖 砖 砖 拽 驻:');
    if (!password) {
        resetRowLoadingState(email, 'recalculate');
        return;
    }
    
    if (password !== 'admin') {
        showNotification('住住 砖', 'error');
        resetRowLoadingState(email, 'recalculate');
        return;
    }
    
    try {
        const response = await fetch(`/pdn-admin/user/recalculate_pdn/${email}?session_token=${sessionToken}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ password: password })
        });
        
        if (response.ok) {
            const data = await response.json();
            showNotification(`拽 驻 砖 砖 爪: ${data.pdn_code} 注  ${data.updated_by}`, 'success');
            
            // Update local data
            const userIndex = currentData.findIndex(u => u.email === email);
            if (userIndex !== -1) {
                currentData[userIndex].pdn_code = data.pdn_code;
                currentData[userIndex].date = data.date;
                // Update the PDN update comments if available
                if (data.pdn_update_comments) {
                    currentData[userIndex].pdn_update_comments = data.pdn_update_comments;
                }
                renderTable(currentData);
            }
            
            // Reset loading state for this specific row
            resetRowLoadingState(email, 'recalculate');
        } else if (response.status === 401) {
            // Session expired or invalid, redirect to login
            console.log('Session expired, redirecting to login');
            localStorage.removeItem('adminSessionToken');
            window.location.href = '/pdn-admin/';
        } else {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'Failed to recalculate PDN code');
        }
    } catch (error) {
        console.error('Error recalculating PDN code:', error);
        showNotification(`砖 砖 砖 砖 拽 驻: ${error.message}`, 'error');
        // Reset loading state for this specific row
        resetRowLoadingState(email, 'recalculate');
    }
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    if (modalId === 'editDiagnoseModal') {
        currentEditEmail = null;
    }
}

function showLoading() {
    document.getElementById('loadingSpinner').classList.remove('hidden');
}

function hideLoading() {
    document.getElementById('loadingSpinner').classList.add('hidden');
}

// Close modals when clicking outside
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal-backdrop')) {
        e.target.style.display = 'none';
    }
});

// Add keyboard event listeners for modal
document.addEventListener('keydown', function(event) {
    const questionnaireModal = document.getElementById('questionnaireModal');
    
    // Check if questionnaire modal is visible
    if (questionnaireModal && questionnaireModal.style.display === 'flex') {
        // Close on Escape key
        if (event.key === 'Escape') {
            closeModal('questionnaireModal');
        }
        // Close on Enter key
        if (event.key === 'Enter') {
            closeModal('questionnaireModal');
        }
    }
});

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-6 right-6 z-[9999] p-6 rounded-xl shadow-2xl transition-all duration-500 transform translate-x-full border-2`;
    
    // Enhanced styling based on type
    let bgColor, borderColor, icon, textColor;
    switch(type) {
        case 'success':
            bgColor = 'bg-green-50';
            borderColor = 'border-green-500';
            icon = 'fa-check-circle';
            textColor = 'text-green-800';
            break;
        case 'error':
            bgColor = 'bg-red-50';
            borderColor = 'border-red-500';
            icon = 'fa-exclamation-triangle';
            textColor = 'text-red-800';
            break;
        case 'warning':
            bgColor = 'bg-yellow-50';
            borderColor = 'border-yellow-500';
            icon = 'fa-exclamation-circle';
            textColor = 'text-yellow-800';
            break;
        default:
            bgColor = 'bg-blue-50';
            borderColor = 'border-blue-500';
            icon = 'fa-info-circle';
            textColor = 'text-blue-800';
    }
    
    notification.className += ` ${bgColor} ${borderColor}`;
    notification.innerHTML = `
        <div class="flex items-start space-x-3 space-x-reverse">
            <div class="flex-shrink-0">
                <i class="fas ${icon} text-xl ${textColor}"></i>
            </div>
            <div class="flex-1 min-w-0">
                <p class="text-sm font-medium ${textColor} leading-5">${message}</p>
            </div>
            <div class="flex-shrink-0">
                <button onclick="this.closest('.notification-item').remove()" 
                        class="inline-flex text-gray-400 hover:text-gray-600 transition-colors duration-200">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
        </div>
    `;
    
    // Add a unique class for easier targeting
    notification.classList.add('notification-item');
    
    document.body.appendChild(notification);
    
    // Animate in with bounce effect
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
        notification.classList.add('animate-bounce');
        setTimeout(() => {
            notification.classList.remove('animate-bounce');
        }, 1000);
    }, 100);
    
    // Auto remove after 8 seconds (increased from 5)
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 500);
    }, 8000);
    
    // Add sound for error notifications
    if (type === 'error') {
        // Create a simple beep sound
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
        
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.2);
    }
}

// Add this new function to reset loading state for a specific row
function resetRowLoadingState(email, buttonType) {
    // Find the row for this email
    const rows = document.querySelectorAll('#tableBody tr');
    rows.forEach(row => {
        const emailCell = row.querySelector('td:first-child');
        if (emailCell && emailCell.textContent.trim() === email) {
            // Find the Alpine component in this row
            const alpineComponent = row.querySelector('[x-data]');
            if (alpineComponent && alpineComponent._x_dataStack && alpineComponent._x_dataStack[0]) {
                alpineComponent._x_dataStack[0].loadingBtn = '';
                alpineComponent._x_dataStack[0].showModal = false;
            }
        }
    });
}

// Update the existing resetAlpineLoadingState function
function resetAlpineLoadingState() {
    // Reset all Alpine components
    document.querySelectorAll('[x-data]').forEach(element => {
        if (element._x_dataStack && element._x_dataStack[0]) {
            element._x_dataStack[0].loadingBtn = '';
            element._x_dataStack[0].showModal = false;
        }
    });
}

async function downloadCsvFile() {
    try {
        showLoading();
        const response = await fetch(`/pdn-admin/download/csv?session_token=${sessionToken}`);
        
        if (response.ok) {
            // Get the blob from the response
            const blob = await response.blob();
            
            // Create a download link
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'user_metadata.csv';
            
            // Trigger download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Clean up the URL object
            window.URL.revokeObjectURL(url);
            
            showNotification('拽抓 专 爪!', 'success');
        } else if (response.status === 404) {
            showNotification('拽抓 CSV  爪', 'error');
        } else {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
    } catch (error) {
        console.error('Error downloading CSV:', error);
        showNotification('砖 专转 拽抓', 'error');
    } finally {
        hideLoading();
    }
}

function downloadTableAsCsv(data) {
    if (!data || data.length === 0) {
        alert(' 转 专');
        return;
    }
    // Define the columns to export
    const columns = [
        { key: 'email', label: '' },
        { key: 'date', label: '转专 ' },
        { key: 'pdn_code', label: '驻 拽' },
        { key: 'pdn_voice_code', label: '转 拽 拽' },
        { key: 'diagnose_pdn_code', label: '拽 ' },
        { key: 'diagnose_comments', label: '注专转 ' }
    ];
    let csvContent = columns.map(col => col.label).join(',') + '\n';
    data.forEach(row => {
        csvContent += columns.map(col => '"' + (row[col.key] || '').replace(/"/g, '""') + '"').join(',') + '\n';
    });
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.setAttribute('download', 'user_metadata.csv');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

</script>
</body>
</html> 